<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>重读Magisk内部实现细节 - 佛光普照</title><meta name="author" content="tcc0lin">
<meta name="description" content="前言 相信Magisk对于移动安全从业者来说都不陌生了，我虽然也是一个版本接着一个版本的使用，但是始终没有去摸透Magisk的生态，希望借助之后想写的Magisk系列的文章来深度学习下Magisk，也正如Magisk在其主页所说的那样
"><meta name="keywords" content='源码分析'>
  <meta itemprop="name" content="重读Magisk内部实现细节">
  <meta itemprop="description" content="前言 相信Magisk对于移动安全从业者来说都不陌生了，我虽然也是一个版本接着一个版本的使用，但是始终没有去摸透Magisk的生态，希望借助之后想写的Magisk系列的文章来深度学习下Magisk，也正如Magisk在其主页所说的那样">
  <meta itemprop="datePublished" content="2023-06-09T22:36:47+08:00">
  <meta itemprop="dateModified" content="2023-06-09T22:36:47+08:00">
  <meta itemprop="wordCount" content="17756">
  <meta itemprop="keywords" content="源码分析"><meta property="og:url" content="http://localhost:1313/posts/%E9%87%8D%E8%AF%BBmagisk%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/">
  <meta property="og:site_name" content="佛光普照">
  <meta property="og:title" content="重读Magisk内部实现细节">
  <meta property="og:description" content="前言 相信Magisk对于移动安全从业者来说都不陌生了，我虽然也是一个版本接着一个版本的使用，但是始终没有去摸透Magisk的生态，希望借助之后想写的Magisk系列的文章来深度学习下Magisk，也正如Magisk在其主页所说的那样">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-06-09T22:36:47+08:00">
    <meta property="article:modified_time" content="2023-06-09T22:36:47+08:00">
    <meta property="article:tag" content="源码分析">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="重读Magisk内部实现细节">
  <meta name="twitter:description" content="前言 相信Magisk对于移动安全从业者来说都不陌生了，我虽然也是一个版本接着一个版本的使用，但是始终没有去摸透Magisk的生态，希望借助之后想写的Magisk系列的文章来深度学习下Magisk，也正如Magisk在其主页所说的那样">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/tcc0lin_fav.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="http://localhost:1313/posts/%E9%87%8D%E8%AF%BBmagisk%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/" title="重读Magisk内部实现细节 - 佛光普照" /><link rel="prev" type="text/html" href="http://localhost:1313/posts/feistel%E5%AF%86%E7%A0%81%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/" title="Feistel密码结构学习" /><link rel="next" type="text/html" href="http://localhost:1313/posts/%E9%87%8D%E8%AF%BBmagisk%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%822/" title="重读Magisk内部实现细节2" /><link rel="alternate" type="text/markdown" href="http://localhost:1313/posts/%E9%87%8D%E8%AF%BBmagisk%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/index.md" title="重读Magisk内部实现细节 - 佛光普照"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "重读Magisk内部实现细节",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/%E9%87%8D%E8%AF%BBmagisk%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82\/"
    },"genre": "posts","keywords": "源码分析","wordcount":  17756 ,
    "url": "http:\/\/localhost:1313\/posts\/%E9%87%8D%E8%AF%BBmagisk%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82\/","datePublished": "2023-06-09T22:36:47+08:00","dateModified": "2023-06-09T22:36:47+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "tcc0lin"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper" data-github-corner="right">
    <div class="header-title">
      <a href="/" title="佛光普照"><span class="header-title-text">tcc0lin&#39;s security blog</span></a><span class="typeit header-subtitle"><template>佛光普照，威胁无处遁形</template></span></div>
    <nav>
      <ul class="menu"><li class="menu-item has-children">
              <a class="menu-link" href="/documentation/"><i class="fa-regular fa-newspaper fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 文档</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i>
                <ul class="sub-menu"><li class="menu-item">
                        <a class="menu-link" href="/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 分类</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/collections/"><i class="fa-solid fa-layer-group fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 合集</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a>
                      </li></ul></li><li class="menu-item">
              <a class="menu-link" href="/showcase/"><i class="fa-solid fa-blog fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 案例展示</a></li><li class="menu-item">
              <a class="menu-link" href="/thinks/"><i class="fa-solid fa-brain fa-fw fa-sm" aria-hidden="true"></i> 近期思考</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="佛光普照"><span class="header-title-text">tcc0lin&#39;s security blog</span></a><span class="typeit header-subtitle"><template>佛光普照，威胁无处遁形</template></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li class="menu-item"><span class="nested-item">
                  <a class="menu-link" href="/documentation/"><i class="fa-regular fa-newspaper fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 文档</a>
                  <i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden="true"></i>
                </span>
                <ul class="sub-menu"><li class="menu-item">
                        <a class="menu-link" href="/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 分类</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/collections/"><i class="fa-solid fa-layer-group fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 合集</a>
                      </li><li class="menu-item">
                        <a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a>
                      </li></ul></li><li class="menu-item"><a class="menu-link" href="/showcase/"><i class="fa-solid fa-blog fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 案例展示</a></li><li class="menu-item"><a class="menu-link" href="/thinks/"><i class="fa-solid fa-brain fa-fw fa-sm" aria-hidden="true"></i> 近期思考</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><nav aria-label="breadcrumb" class="breadcrumb-container sticky">
    <ol class="breadcrumb"><li class="breadcrumb-item" data-separator="/"><a href="/" title="佛光普照">主页</a></li><li class="breadcrumb-item" data-separator="/"><a href="/posts/" title="Posts">文章</a></li><li class="breadcrumb-item active" data-separator="/" aria-current="page">重读Magisk内部实现细节</li>
    </ol>
  </nav><main class="container container-reverse"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>重读Magisk内部实现细节</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/tcc0lin.png" alt="tcc0lin" data-title="tcc0lin" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;tcc0lin</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/magisk/" class="post-category" title="分类 - Magisk"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Magisk</a></span></div><div class="post-meta-line"><span title="发布于 2023-06-09 22:36:47"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-06-09">2023-06-09</time></span>&nbsp;<span title="17756 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 17800 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 36 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#前言">前言</a></li>
        <li><a href="#一预备知识">一、预备知识</a></li>
        <li><a href="#二什么是root">二、什么是Root？</a></li>
        <li><a href="#三android是如何限制root的">三、Android是如何限制Root的？</a></li>
        <li><a href="#四magisk是如何工作的">四、Magisk是如何工作的？</a>
          <ul>
            <li><a href="#1-patch-boot">1 patch boot</a>
              <ul>
                <li><a href="#11-boot_patch分块解析">1.1 boot_patch分块解析</a></li>
                <li><a href="#12-magiskboot的作用">1.2 magiskboot的作用</a>
                  <ul>
                    <li><a href="#121-main">1.2.1 main</a></li>
                    <li><a href="#122-unpack">1.2.2 unpack</a></li>
                    <li><a href="#123-cpio">1.2.3 cpio</a></li>
                    <li><a href="#124-dtb">1.2.4 dtb</a></li>
                    <li><a href="#125-hexpatch">1.2.5 hexpatch</a></li>
                    <li><a href="#126-repack">1.2.6 repack</a></li>
                    <li><a href="#127-patch示例">1.2.7 patch示例</a></li>
                  </ul>
                </li>
                <li><a href="#13-patch-boot流程图">1.3 patch boot流程图</a></li>
              </ul>
            </li>
            <li><a href="#2-booting-process">2 booting process</a>
              <ul>
                <li><a href="#21-android启动方式的演变">2.1 android启动方式的演变</a>
                  <ul>
                    <li><a href="#211-method-a---传统的ramdisk">2.1.1 Method A - 传统的ramdisk</a></li>
                    <li><a href="#212-method-b---传统的sar机制">2.1.2 Method B - 传统的SAR机制</a></li>
                    <li><a href="#212-method-c---两阶段初始化ramdisk-to-sar">2.1.2 Method C - 两阶段初始化（ramdisk to SAR）</a></li>
                  </ul>
                </li>
                <li><a href="#22-magiskinit的处理">2.2 magiskinit的处理</a>
                  <ul>
                    <li><a href="#221-rootfsinit">2.2.1 RootFSInit</a></li>
                    <li><a href="#222-recoveryinit">2.2.2 RecoveryInit</a></li>
                    <li><a href="#223-sarinit">2.2.3 SARInit</a></li>
                    <li><a href="#224-firststageinitsecondstageinit">2.2.4 FirstStageInit/SecondStageInit</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#五参考">五、参考</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h3 id="前言" class="heading-element"><span>前言</span>
  <a href="#%e5%89%8d%e8%a8%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>相信Magisk对于移动安全从业者来说都不陌生了，我虽然也是一个版本接着一个版本的使用，但是始终没有去摸透Magisk的生态，希望借助之后想写的Magisk系列的文章来深度学习下Magisk，也正如Magisk在其主页所说的那样</p>
<blockquote>
<p>Magisk is a suite of open source software for customizing Android, supporting devices higher than Android 6.0.
Some highlight features:</p>
<ul>
<li>MagiskSU: Provide root access for applications</li>
<li>Magisk Modules: Modify read-only partitions by installing modules</li>
<li>MagiskBoot: The most complete tool for unpacking and repacking Android boot images</li>
<li>Zygisk: Run code in every Android applications&rsquo; processes</li>
</ul></blockquote>
<p>Magisk作为一套工具包，它的实现原理（包括它的su实现、boot patch、module机制等等）都是很值得去阅读理解的</p>
<h3 id="一预备知识" class="heading-element"><span>一、预备知识</span>
  <a href="#%e4%b8%80%e9%a2%84%e5%a4%87%e7%9f%a5%e8%af%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>boot.img的组成</li>
<li>android启动流程</li>
<li>android secure体系</li>
<li>linux存储</li>
<li>&hellip;&hellip;</li>
</ul>
<h3 id="二什么是root" class="heading-element"><span>二、什么是Root？</span>
  <a href="#%e4%ba%8c%e4%bb%80%e4%b9%88%e6%98%afroot" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Android平台的基础是Linux内核，每个应用被严格控制运行在自己的沙盒中，不能越过边界，但是拥有Root权限就意味着你可以绕过内核的权限校验去任意执行你想要的功能。</p>
<h3 id="三android是如何限制root的" class="heading-element"><span>三、Android是如何限制Root的？</span>
  <a href="#%e4%b8%89android%e6%98%af%e5%a6%82%e4%bd%95%e9%99%90%e5%88%b6root%e7%9a%84" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在Android4.3之前的版本中，android会给每一个应用分配一个独一无二的ID（也就是user-ID，也称为UID），所以每个应用都有自己的权限边界，这个时候想要拥有Root权限的话，可以通过set-user-ID-root的机制执行su二进制文件来进行提权或者通过setgid/setuid来让自己拥有更多的权限。</p>
<p>但是自从Android4.3推出<a href="https://source.android.com/docs/security/enhancements/enhancements43"target="_blank" rel="external nofollow noopener noreferrer">Security Enhancements in Android 4.3</a>之后，堵住了setgid/setuid入口，引入了全新的安全体系（基于强制访问控制(MAC)的SELinux），构成了SEAndroid，进一步定义Android应用沙盒的边界，运行在单独的进程中，所以每个应用都有自己的权限边界，这样即使是进程具有root的能力，SELinux依然可以通过创建安全策略(sepolicy)来限制root进程的能力范围来增强Android的安全性。而在Android4.4之后推出的<a href="https://source.android.com/docs/security/enhancements/enhancements44"target="_blank" rel="external nofollow noopener noreferrer">Security Enhancements in Android 4.4</a>，进一步要求Android打开了SELinux的Enforcing模式。</p>
<p>上面这种改变也是因为过去的Android安全机制是基于DAC（自主访问控制）来实现的，其原理就是：进程理论上所拥有的权限与执行它的用户的权限相同，DAC使用了ACL（Access Control List，访问控制列表）来给非管理者用户提供不同的权限，而root用户对文件系统有完全自由的控制权，因此，想办法把自己的权限提升到root用户就可以完成任何事情。而正是因为这种宽松的管理方式，促使MAC（强制访问控制）的诞生，MAC核心思想：即任何进程想在SELinux系统中干任何事情，都必须先在安全策略配置文件中赋予权限，MAC不再像DAC一样简单的把进程分为root/others等，而是每个进程（Subject，主体）和文件（Object，客体）都配置了一个类型（Type），当一个进程去操控（读写等）一个文件时，系统会检测该进程类型是否有对该文件类型的操作权限</p>
<p>例如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(base)  ✘ 大慈大悲观世音菩萨  ~/Projects/Android_boot_image_editor   master  as
</span></span><span class="line"><span class="cl">selene:/ $ ps -efZ|grep miui
</span></span><span class="line"><span class="cl">u:r:miuibooster:s0             root            943      1 0 17:43:34 ?     00:00:00 miuibooster
</span></span><span class="line"><span class="cl">u:r:platform_app:s0:c512,c768  u0_a122        1597    611 0 17:43:43 ?     00:00:01 com.miui.miwallpaper
</span></span><span class="line"><span class="cl">u:r:platform_app:s0:c512,c768  u0_a102        1950    610 0 17:43:44 ?     00:00:06 com.miui.home
</span></span><span class="line"><span class="cl">u:r:untrusted_app:s0:c234,c256,c512,c768 u0_a234 2212 610 0 17:43:45 ?     00:00:00 com.miui.weather2
</span></span><span class="line"><span class="cl">u:r:platform_app:s0:c512,c768  u0_a163        2572    611 0 17:43:49 ?     00:00:00 com.miui.voiceassist
</span></span><span class="line"><span class="cl">u:r:system_app:s0              system         2616    610 0 17:43:49 ?     00:00:00 com.miui.contentcatcher
</span></span><span class="line"><span class="cl">u:r:system_app:s0              system         2667    610 0 17:43:49 ?     00:00:02 com.miui.daemon
</span></span><span class="line"><span class="cl">u:r:system_app:s0              system         2794    610 0 17:43:49 ?     00:00:00 com.miui.face
</span></span><span class="line"><span class="cl">u:r:untrusted_app:s0:c512,c768 u0_a78         2902    610 0 17:43:50 ?     00:00:00 com.miui.personalassistant
</span></span><span class="line"><span class="cl">u:r:system_app:s0              system         2971    610 0 17:43:50 ?     00:00:00 com.miui.notification:remote</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，像miuibooster、platform_app这样即表示进程归属的type，而具体的type的权限可以从<a href="https://android.googlesource.com/platform/external/sepolicy/&#43;/jb-mr1-dev/app.te"target="_blank" rel="external nofollow noopener noreferrer">官方的te文件中查找</a></p>
<p>因此，在Android4.4之后，获取Root面临的困难是先DAC、后MAC的访问权限控制，市面上通用的做法是修改sepolicy获得一个不受限制的SELinux context，当拥有这个context之后，就可以修改init.rc启动类似su daemon的服务，这样保障了系统运行时后台随时都存在一个拥有root权限的服务，剩下需要做的就只是考虑该如何和这个daemon进行通信</p>
<h3 id="四magisk是如何工作的" class="heading-element"><span>四、Magisk是如何工作的？</span>
  <a href="#%e5%9b%9bmagisk%e6%98%af%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c%e7%9a%84" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>有了上面对于android权限访问控制体系以及现阶段Root实现方式的了解，我们大概能猜到Magisk是如何实现Root的了？那么Magisk它具体的实现包括</p>
<ul>
<li>如何修改sepolicy、init.rc？</li>
<li>如何做到systemless的？</li>
<li>如何适配多种版本、机型？</li>
<li>是否具备扩展功能？</li>
<li>&hellip;&hellip;</li>
</ul>
<p>是如何实现的呢，接下来通过源码来分析下</p>
<p>下面正式开始分析Magisk的内部工作原理（大家都知道Magisk在v24.1之后推出了Zygisk的模式，为了避免新增部分影响我们对于原始流程的分析，因此我选择先忽略掉这部分，以前一个版本v23.0的源码来作为样本阅读）</p>
<h4 id="1-patch-boot" class="heading-element"><span>1 patch boot</span>
  <a href="#1-patch-boot" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>Magisk Manager做的第一步就是对boot的修补，所以第一步就从Magisk Manager的修补boot页面开始追下来</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="line"><span class="cl"><span class="c1">// com/topjohnwu/magisk/ui/install/InstallFragment.kt
</span></span></span><span class="line"><span class="cl"><span class="c1">// 对应layout
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">InstallFragment</span> <span class="p">:</span> <span class="n">BaseUIFragment</span><span class="p">&lt;</span><span class="n">InstallViewModel</span><span class="p">,</span> <span class="n">FragmentInstallMd2Binding</span><span class="p">&gt;()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">val</span> <span class="py">layoutRes</span> <span class="p">=</span> <span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">fragment_install_md2</span>
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">val</span> <span class="py">viewModel</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">&lt;</span><span class="n">InstallViewModel</span><span class="p">&gt;()</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// layout/fragment_install_md2.xml
</span></span></span><span class="line"><span class="cl"><span class="c1">// layout中的开始按钮，对应的方法是InstallViewModel中的install方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">&lt;</span><span class="n">Button</span>
</span></span><span class="line"><span class="cl">    <span class="n">style</span><span class="p">=</span><span class="s2">&#34;@style/WidgetFoundation.Button.Text&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gone</span><span class="p">=</span><span class="s2">&#34;@{viewModel.step != 1}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">isEnabled</span><span class="p">=</span><span class="s2">&#34;@{viewModel.method == @id/method_patch ? viewModel.data != null : viewModel.method != -1}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">android</span><span class="p">:</span><span class="n">layout_width</span><span class="p">=</span><span class="s2">&#34;wrap_content&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">android</span><span class="p">:</span><span class="n">layout_height</span><span class="p">=</span><span class="s2">&#34;wrap_content&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">android</span><span class="p">:</span><span class="n">onClick</span><span class="p">=</span><span class="s2">&#34;@{() -&gt; viewModel.install()}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">android</span><span class="p">:</span><span class="n">text</span><span class="p">=</span><span class="s2">&#34;@string/install_start&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="p">:</span><span class="n">icon</span><span class="p">=</span><span class="s2">&#34;@drawable/ic_forth_md2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="p">:</span><span class="n">iconGravity</span><span class="p">=</span><span class="s2">&#34;textEnd&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// com/topjohnwu/magisk/ui/install/InstallViewModel.kt
</span></span></span><span class="line"><span class="cl"><span class="c1">// 引导出FlashFragment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">fun</span> <span class="nf">install</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">when</span> <span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">method_patch</span> <span class="o">-&gt;</span> <span class="nc">FlashFragment</span><span class="p">.</span><span class="n">patch</span><span class="p">(</span><span class="k">data</span><span class="o">!!</span><span class="p">).</span><span class="n">navigate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">method_direct</span> <span class="o">-&gt;</span> <span class="nc">FlashFragment</span><span class="p">.</span><span class="n">flash</span><span class="p">(</span><span class="k">false</span><span class="p">).</span><span class="n">navigate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">method_inactive_slot</span> <span class="o">-&gt;</span> <span class="nc">FlashFragment</span><span class="p">.</span><span class="n">flash</span><span class="p">(</span><span class="k">true</span><span class="p">).</span><span class="n">navigate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unknown value&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="p">=</span> <span class="nc">State</span><span class="p">.</span><span class="n">LOADING</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// com/topjohnwu/magisk/ui/flash/FlashFragment.kt
</span></span></span><span class="line"><span class="cl"><span class="c1">// 类似onCreate方法，触发startFlashing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">override</span> <span class="k">fun</span> <span class="nf">onViewCreated</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">View</span><span class="p">,</span> <span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">onViewCreated</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">savedInstanceState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">defaultOrientation</span> <span class="p">=</span> <span class="n">activity</span><span class="p">.</span><span class="n">requestedOrientation</span>
</span></span><span class="line"><span class="cl">    <span class="n">activity</span><span class="p">.</span><span class="n">requestedOrientation</span> <span class="p">=</span> <span class="nc">ActivityInfo</span><span class="p">.</span><span class="n">SCREEN_ORIENTATION_NOSENSOR</span>
</span></span><span class="line"><span class="cl">    <span class="n">viewModel</span><span class="p">.</span><span class="n">startFlashing</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// com/topjohnwu/magisk/ui/flash/FlashViewModel.kt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nc">Const</span><span class="p">.</span><span class="nc">Value</span><span class="p">.</span><span class="n">PATCH_FILE</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">uri</span> <span class="o">?:</span> <span class="k">return</span><span class="nd">@launch</span>
</span></span><span class="line"><span class="cl">    <span class="n">showReboot</span> <span class="p">=</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">    <span class="nc">MagiskInstaller</span><span class="p">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">outItems</span><span class="p">,</span> <span class="n">logItems</span><span class="p">).</span><span class="n">exec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// com/topjohnwu/magisk/core/tasks/MagiskInstaller.kt
</span></span></span><span class="line"><span class="cl"><span class="c1">// patchFile也就是传入的原生boot.img
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">protected</span> <span class="k">fun</span> <span class="nf">doPatchFile</span><span class="p">(</span><span class="n">patchFile</span><span class="p">:</span> <span class="n">Uri</span><span class="p">)</span> <span class="p">=</span> <span class="n">extractFiles</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">handleFile</span><span class="p">(</span><span class="n">patchFile</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>进入到关键类：MagiskInstaller</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">extractFiles</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建/data/data/package_name/install目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">installDir</span> <span class="p">=</span> <span class="n">File</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">filesDir</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&#34;install&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">installDir</span><span class="p">.</span><span class="n">deleteRecursively</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">installDir</span><span class="p">.</span><span class="n">mkdirs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Extract binaries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 从stub或者full中获取so文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">isRunningAsStub</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">zf</span> <span class="p">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="nc">DynAPK</span><span class="p">.</span><span class="n">current</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">zf</span><span class="p">.</span><span class="n">entries</span><span class="p">().</span><span class="n">asSequence</span><span class="p">().</span><span class="n">filter</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="p">!</span><span class="k">it</span><span class="p">.</span><span class="n">isDirectory</span> <span class="o">&amp;&amp;</span> <span class="k">it</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s2">&#34;lib/</span><span class="si">${Const.CPU_ABI_32}</span><span class="s2">/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}.</span><span class="n">forEach</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">val</span> <span class="py">n</span> <span class="p">=</span> <span class="k">it</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="k">it</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">lastIndexOf</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">+</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">val</span> <span class="py">name</span> <span class="p">=</span> <span class="n">n</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">length</span> <span class="p">-</span> <span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">val</span> <span class="py">dest</span> <span class="p">=</span> <span class="n">File</span><span class="p">(</span><span class="n">installDir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">zf</span><span class="p">.</span><span class="n">getInputStream</span><span class="p">(</span><span class="k">it</span><span class="p">).</span><span class="n">writeTo</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 获取lib库中的so文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">val</span> <span class="py">libs</span> <span class="p">=</span> <span class="nc">Const</span><span class="p">.</span><span class="nc">NATIVE_LIB_DIR</span><span class="p">.</span><span class="n">listFiles</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="n">name</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s2">&#34;lib&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="p">.</span><span class="n">endsWith</span><span class="p">(</span><span class="s2">&#34;.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="o">?:</span> <span class="n">emptyArray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="n">lib</span> <span class="k">in</span> <span class="n">libs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 重命名so文件并做软链，例如libmagiskboot.so-&gt;magiskboot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 并软链到/data/data/package_name/install/magiskboot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">val</span> <span class="py">name</span> <span class="p">=</span> <span class="n">lib</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="n">lib</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">length</span> <span class="p">-</span> <span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nc">Os</span><span class="p">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">lib</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&#34;</span><span class="si">$installDir</span><span class="s2">/</span><span class="si">$name</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Extract scripts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 从asset目录中抽出三个shell脚本
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">script</span> <span class="k">in</span> <span class="n">listOf</span><span class="p">(</span><span class="s2">&#34;util_functions.sh&#34;</span><span class="p">,</span> <span class="s2">&#34;boot_patch.sh&#34;</span><span class="p">,</span> <span class="s2">&#34;addon.d.sh&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">dest</span> <span class="p">=</span> <span class="n">File</span><span class="p">(</span><span class="n">installDir</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">.</span><span class="n">assets</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="n">script</span><span class="p">).</span><span class="n">writeTo</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Extract chromeos tools
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 同理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">File</span><span class="p">(</span><span class="n">installDir</span><span class="p">,</span> <span class="s2">&#34;chromeos&#34;</span><span class="p">).</span><span class="n">mkdir</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">file</span> <span class="k">in</span> <span class="n">listOf</span><span class="p">(</span><span class="s2">&#34;futility&#34;</span><span class="p">,</span> <span class="s2">&#34;kernel_data_key.vbprivk&#34;</span><span class="p">,</span> <span class="s2">&#34;kernel.keyblock&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">name</span> <span class="p">=</span> <span class="s2">&#34;chromeos/</span><span class="si">$file</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">dest</span> <span class="p">=</span> <span class="n">File</span><span class="p">(</span><span class="n">installDir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">.</span><span class="n">assets</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="n">name</span><span class="p">).</span><span class="n">writeTo</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;! Unable to extract files&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Timber</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>extractFiles这一步做的功能就是准备资源，把so文件变成可执行文件以及准备好shell脚本，根据Apk对应下的目录可看到文件如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>base<span class="o">)</span>  大慈大悲观世音菩萨  ~/Downloads/Magisk-v23.0 <span class="o">(</span>1<span class="o">)</span>  ll assets
</span></span><span class="line"><span class="cl">total <span class="m">88</span>
</span></span><span class="line"><span class="cl">-rw-rw-rw-@ <span class="m">1</span> tcc0lin  staff   3.4K  <span class="m">1</span>  <span class="m">1</span>  <span class="m">1981</span> addon.d.sh
</span></span><span class="line"><span class="cl">-rw-rw-rw-@ <span class="m">1</span> tcc0lin  staff   5.3K  <span class="m">1</span>  <span class="m">1</span>  <span class="m">1981</span> boot_patch.sh
</span></span><span class="line"><span class="cl">drwxr-xr-x@ <span class="m">5</span> tcc0lin  staff   160B  <span class="m">5</span> <span class="m">31</span> 09:08 chromeos
</span></span><span class="line"><span class="cl">-rw-rw-rw-@ <span class="m">1</span> tcc0lin  staff   4.6K  <span class="m">1</span>  <span class="m">1</span>  <span class="m">1981</span> uninstaller.sh
</span></span><span class="line"><span class="cl">-rw-rw-rw-@ <span class="m">1</span> tcc0lin  staff    22K  <span class="m">1</span>  <span class="m">1</span>  <span class="m">1981</span> util_functions.sh
</span></span><span class="line"><span class="cl"><span class="o">(</span>base<span class="o">)</span>  大慈大悲观世音菩萨  ~/Downloads/Magisk-v23.0 <span class="o">(</span>1<span class="o">)</span>  ll lib/armeabi-v7a
</span></span><span class="line"><span class="cl">total <span class="m">4472</span>
</span></span><span class="line"><span class="cl">-rw-rw-rw-@ <span class="m">1</span> tcc0lin  staff   1.4M  <span class="m">1</span>  <span class="m">1</span>  <span class="m">1981</span> libbusybox.so
</span></span><span class="line"><span class="cl">-rw-rw-rw-@ <span class="m">1</span> tcc0lin  staff   102K  <span class="m">1</span>  <span class="m">1</span>  <span class="m">1981</span> libmagisk32.so
</span></span><span class="line"><span class="cl">-rw-rw-rw-@ <span class="m">1</span> tcc0lin  staff   166K  <span class="m">1</span>  <span class="m">1</span>  <span class="m">1981</span> libmagisk64.so
</span></span><span class="line"><span class="cl">-rw-rw-rw-@ <span class="m">1</span> tcc0lin  staff   272K  <span class="m">1</span>  <span class="m">1</span>  <span class="m">1981</span> libmagiskboot.so
</span></span><span class="line"><span class="cl">-rw-rw-rw-@ <span class="m">1</span> tcc0lin  staff   302K  <span class="m">1</span>  <span class="m">1</span>  <span class="m">1981</span> libmagiskinit.so</span></span></code></pre></td></tr></table>
</div>
</div><p>下一步是对传入的boot.img的具体处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">handleFile</span><span class="p">(</span><span class="n">uri</span><span class="p">:</span> <span class="n">Uri</span><span class="p">):</span> <span class="n">Boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">outStream</span><span class="p">:</span> <span class="n">OutputStream</span>
</span></span><span class="line"><span class="cl">    <span class="k">var</span> <span class="py">outFile</span><span class="p">:</span> <span class="nc">MediaStoreUtils</span><span class="p">.</span><span class="n">UriFile</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Process input file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">uri</span><span class="p">.</span><span class="n">inputStream</span><span class="p">().</span><span class="n">buffered</span><span class="p">().</span><span class="n">use</span> <span class="p">{</span> <span class="n">src</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">src</span><span class="p">.</span><span class="n">mark</span><span class="p">(</span><span class="m">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">......</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 随机给新boot起名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">val</span> <span class="py">alpha</span> <span class="p">=</span> <span class="s2">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">alphaNum</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="si">$alpha${alpha.toUpperCase(Locale.ROOT)}</span><span class="s2">0123456789&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">random</span> <span class="p">=</span> <span class="n">SecureRandom</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">filename</span> <span class="p">=</span> <span class="n">StringBuilder</span><span class="p">(</span><span class="s2">&#34;magisk_patched-</span><span class="si">${BuildConfig.VERSION_CODE}</span><span class="s2">_&#34;</span><span class="p">).</span><span class="n">run</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="m">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">append</span><span class="p">(</span><span class="n">alphaNum</span><span class="p">[</span><span class="n">random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="n">alphaNum</span><span class="p">.</span><span class="n">length</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">toString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">outStream</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">magic</span><span class="p">.</span><span class="n">contentEquals</span><span class="p">(</span><span class="s2">&#34;ustar&#34;</span><span class="p">.</span><span class="n">toByteArray</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// tar file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">outFile</span> <span class="p">=</span> <span class="nc">MediaStoreUtils</span><span class="p">.</span><span class="n">getFile</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$filename</span><span class="s2">.tar&#34;</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">processTar</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">outFile</span><span class="o">!!</span><span class="p">.</span><span class="n">uri</span><span class="p">.</span><span class="n">outputStream</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// raw image
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 以处理boot.img为例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">srcBoot</span> <span class="p">=</span> <span class="n">installDirFile</span><span class="p">(</span><span class="s2">&#34;boot.img&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">console</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;- Copying image to cache&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">src</span><span class="p">.</span><span class="n">cleanPump</span><span class="p">(</span><span class="nc">SuFileOutputStream</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="n">srcBoot</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">outFile</span> <span class="p">=</span> <span class="nc">MediaStoreUtils</span><span class="p">.</span><span class="n">getFile</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$filename</span><span class="s2">.img&#34;</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">outFile</span><span class="o">!!</span><span class="p">.</span><span class="n">uri</span><span class="p">.</span><span class="n">outputStream</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">IOException</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;! Process error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">outFile</span><span class="o">?.</span><span class="n">delete</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Timber</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Patch file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(!</span><span class="n">patchBoot</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">outFile</span><span class="o">!!</span><span class="p">.</span><span class="n">delete</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">patchBoot</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">var</span> <span class="py">isSigned</span> <span class="p">=</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">srcBoot</span><span class="p">.</span><span class="n">let</span> <span class="p">{</span> <span class="k">it</span> <span class="o">!is</span> <span class="n">SuFile</span> <span class="o">||</span> <span class="p">!</span><span class="k">it</span><span class="p">.</span><span class="n">isCharacter</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nc">SuFileInputStream</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="n">srcBoot</span><span class="p">).</span><span class="n">use</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// AVB验证检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="nc">SignBoot</span><span class="p">.</span><span class="n">verifySignature</span><span class="p">(</span><span class="k">it</span><span class="p">,</span> <span class="k">null</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">isSigned</span> <span class="p">=</span> <span class="k">true</span>
</span></span><span class="line"><span class="cl">                    <span class="n">console</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;- Boot image is signed with AVB 1.0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">IOException</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">console</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;! Unable to check signature&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nc">Timber</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 新建new-boot.img
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">newBoot</span> <span class="p">=</span> <span class="n">installDirFile</span><span class="p">(</span><span class="s2">&#34;new-boot.img&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(!</span><span class="n">useRootDir</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Create output files before hand
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">newBoot</span><span class="p">.</span><span class="n">createNewFile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">File</span><span class="p">(</span><span class="n">installDir</span><span class="p">,</span> <span class="s2">&#34;stock_boot.img&#34;</span><span class="p">).</span><span class="n">createNewFile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 修补boot的执行脚本
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">cmds</span> <span class="p">=</span> <span class="n">arrayOf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;cd </span><span class="si">$installDir</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;KEEPFORCEENCRYPT=</span><span class="si">${Config.keepEnc}</span><span class="s2"> &#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;KEEPVERITY=</span><span class="si">${Config.keepVerity}</span><span class="s2"> &#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;RECOVERYMODE=</span><span class="si">${Config.recovery}</span><span class="s2"> &#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;sh boot_patch.sh </span><span class="si">$srcBoot</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(!</span><span class="n">cmds</span><span class="p">.</span><span class="n">sh</span><span class="p">().</span><span class="n">isSuccess</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 环境清理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">job</span> <span class="p">=</span> <span class="n">shell</span><span class="p">.</span><span class="n">newJob</span><span class="p">().</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;./magiskboot cleanup&#34;</span><span class="p">,</span> <span class="s2">&#34;cd /&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// boot.img签名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">isSigned</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">console</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;- Signing boot image with verity keys&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">signed</span> <span class="p">=</span> <span class="nc">File</span><span class="p">.</span><span class="n">createTempFile</span><span class="p">(</span><span class="s2">&#34;signed&#34;</span><span class="p">,</span> <span class="s2">&#34;.img&#34;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">cacheDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">src</span> <span class="p">=</span> <span class="nc">SuFileInputStream</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="n">newBoot</span><span class="p">).</span><span class="n">buffered</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">out</span> <span class="p">=</span> <span class="n">signed</span><span class="p">.</span><span class="n">outputStream</span><span class="p">().</span><span class="n">buffered</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">withStreams</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="k">out</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nc">SignBoot</span><span class="p">.</span><span class="n">doSignature</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="k">out</span><span class="p">,</span> <span class="s2">&#34;/boot&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">IOException</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">console</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;! Unable to sign image&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nc">Timber</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">job</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;cat </span><span class="si">$signed</span><span class="s2"> &gt; </span><span class="si">$newBoot</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;rm -f </span><span class="si">$signed</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">job</span><span class="p">.</span><span class="n">exec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>从上面的分析流程可以看出来，虽然流程涉及到的代码比较复杂，但是单从最终涉及到文件来看，实际上就是依赖于lib中的so文件以及boot_patch.sh脚本，其他的关于AVB验证和非正常boot格式的都可以先忽略</p>
<h5 id="11-boot_patch分块解析" class="heading-element"><span>1.1 boot_patch分块解析</span>
  <a href="#11-boot_patch%e5%88%86%e5%9d%97%e8%a7%a3%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><p>从boot_patch.sh的注释说明中能很清晰的看出可以分成六块内容</p>
<ul>
<li>Initialization
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 判断是否已经加载完资源</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -z <span class="nv">$SOURCEDMODE</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Switch to the location of the script file</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> <span class="s2">&#34;</span><span class="k">$(</span>getdir <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="k">:-</span><span class="nv">$0</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Load utility functions</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 执行util_functions.sh加载函数到当前脚本，同时配置环境变量</span>
</span></span><span class="line"><span class="cl">. ./util_functions.sh
</span></span><span class="line"><span class="cl"><span class="c1"># Check if 64-bit</span>
</span></span><span class="line"><span class="cl">api_level_arch_detect
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取传入的boot.img</span>
</span></span><span class="line"><span class="cl"><span class="nv">BOOTIMAGE</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> -e <span class="s2">&#34;</span><span class="nv">$BOOTIMAGE</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">||</span> abort <span class="s2">&#34;</span><span class="nv">$BOOTIMAGE</span><span class="s2"> does not exist!&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 通过nanddump指令将boot.img dump成字符</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Dump image for MTD/NAND character device boot partitions</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -c <span class="s2">&#34;</span><span class="nv">$BOOTIMAGE</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">nanddump -f boot.img <span class="s2">&#34;</span><span class="nv">$BOOTIMAGE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">BOOTNAND</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$BOOTIMAGE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">BOOTIMAGE</span><span class="o">=</span>boot.img
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Flags</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> -z <span class="nv">$KEEPVERITY</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">KEEPVERITY</span><span class="o">=</span><span class="nb">false</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> -z <span class="nv">$KEEPFORCEENCRYPT</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">KEEPFORCEENCRYPT</span><span class="o">=</span><span class="nb">false</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> -z <span class="nv">$RECOVERYMODE</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">RECOVERYMODE</span><span class="o">=</span><span class="nb">false</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> KEEPVERITY
</span></span><span class="line"><span class="cl"><span class="nb">export</span> KEEPFORCEENCRYPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">chmod -R <span class="m">755</span> .</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>Unpack
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">CHROMEOS</span><span class="o">=</span><span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ui_print <span class="s2">&#34;- Unpacking boot image&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 调用magiskboot来解包boot.img</span>
</span></span><span class="line"><span class="cl">./magiskboot unpack <span class="s2">&#34;</span><span class="nv">$BOOTIMAGE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="nv">$?</span> in
</span></span><span class="line"><span class="cl"><span class="m">0</span> <span class="o">)</span> <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">    abort <span class="s2">&#34;! Unsupported/Unknown image format&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">    ui_print <span class="s2">&#34;- ChromeOS boot image detected&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">CHROMEOS</span><span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">* <span class="o">)</span>
</span></span><span class="line"><span class="cl">    abort <span class="s2">&#34;! Unable to unpack boot image&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="k">esac</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span> -f recovery_dtbo <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">RECOVERYMODE</span><span class="o">=</span>true</span></span></code></pre></td></tr></table>
</div>
</div>在unpack阶段，引入了先前资源准备阶段的一个关键so文件：magiskboot</li>
<li>Ramdisk Restores
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Test patch status and do restore</span>
</span></span><span class="line"><span class="cl">ui_print <span class="s2">&#34;- Checking ramdisk status&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -e ramdisk.cpio <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    ./magiskboot cpio ramdisk.cpio <span class="nb">test</span>
</span></span><span class="line"><span class="cl">    <span class="nv">STATUS</span><span class="o">=</span><span class="nv">$?</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Stock A only system-as-root</span>
</span></span><span class="line"><span class="cl">    <span class="nv">STATUS</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="k">$((</span>STATUS <span class="o">&amp;</span> <span class="m">3</span><span class="k">))</span> in
</span></span><span class="line"><span class="cl"><span class="m">0</span> <span class="o">)</span>  <span class="c1"># Stock boot</span>
</span></span><span class="line"><span class="cl">    ui_print <span class="s2">&#34;- Stock boot image detected&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">SHA1</span><span class="o">=</span><span class="k">$(</span>./magiskboot sha1 <span class="s2">&#34;</span><span class="nv">$BOOTIMAGE</span><span class="s2">&#34;</span> 2&gt;/dev/null<span class="k">)</span>
</span></span><span class="line"><span class="cl">    cat <span class="nv">$BOOTIMAGE</span> &gt; stock_boot.img
</span></span><span class="line"><span class="cl">    <span class="c1"># 这个阶段主要是复制ramdisk，作用是为了保存原生init</span>
</span></span><span class="line"><span class="cl">    cp -af ramdisk.cpio ramdisk.cpio.orig 2&gt;/dev/null
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span> <span class="o">)</span>  <span class="c1"># Magisk patched</span>
</span></span><span class="line"><span class="cl">    ui_print <span class="s2">&#34;- Magisk patched boot image detected&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Find SHA1 of stock boot image</span>
</span></span><span class="line"><span class="cl">    <span class="o">[</span> -z <span class="nv">$SHA1</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">SHA1</span><span class="o">=</span><span class="k">$(</span>./magiskboot cpio ramdisk.cpio sha1 2&gt;/dev/null<span class="k">)</span>
</span></span><span class="line"><span class="cl">    ./magiskboot cpio ramdisk.cpio restore
</span></span><span class="line"><span class="cl">    cp -af ramdisk.cpio ramdisk.cpio.orig
</span></span><span class="line"><span class="cl">    rm -f stock_boot.img
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span> <span class="o">)</span>  <span class="c1"># Unsupported</span>
</span></span><span class="line"><span class="cl">    ui_print <span class="s2">&#34;! Boot image patched by unsupported programs&#34;</span>
</span></span><span class="line"><span class="cl">    abort <span class="s2">&#34;! Please restore back to stock boot image&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="k">esac</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>Ramdisk Patches
上一阶段做了ramdisk的备份，这个阶段开始对ramdisk进行patch
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ui_print <span class="s2">&#34;- Patching ramdisk&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;KEEPVERITY=</span><span class="nv">$KEEPVERITY</span><span class="s2">&#34;</span> &gt; config
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;KEEPFORCEENCRYPT=</span><span class="nv">$KEEPFORCEENCRYPT</span><span class="s2">&#34;</span> &gt;&gt; config
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;RECOVERYMODE=</span><span class="nv">$RECOVERYMODE</span><span class="s2">&#34;</span> &gt;&gt; config
</span></span><span class="line"><span class="cl"><span class="o">[</span> ! -z <span class="nv">$SHA1</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;SHA1=</span><span class="nv">$SHA1</span><span class="s2">&#34;</span> &gt;&gt; config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 压缩magisk成xz</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Compress to save precious ramdisk space</span>
</span></span><span class="line"><span class="cl">./magiskboot <span class="nv">compress</span><span class="o">=</span>xz magisk32 magisk32.xz
</span></span><span class="line"><span class="cl">./magiskboot <span class="nv">compress</span><span class="o">=</span>xz magisk64 magisk64.xz
</span></span><span class="line"><span class="cl"><span class="nv">$IS64BIT</span> <span class="o">&amp;&amp;</span> <span class="nv">SKIP64</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="o">||</span> <span class="nv">SKIP64</span><span class="o">=</span><span class="s2">&#34;#&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 对ramdisk进行修改，添加入magisk定制的magiskinit以及magisk，后面会着重讲到</span>
</span></span><span class="line"><span class="cl">./magiskboot cpio ramdisk.cpio <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;add 0750 init magiskinit&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;mkdir 0750 overlay.d&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;mkdir 0750 overlay.d/sbin&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;add 0644 overlay.d/sbin/magisk32.xz magisk32.xz&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;</span><span class="nv">$SKIP64</span><span class="s2"> add 0644 overlay.d/sbin/magisk64.xz magisk64.xz&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;patch&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;backup ramdisk.cpio.orig&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;mkdir 000 .backup&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;add 000 .backup/.magisk config&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">rm -f ramdisk.cpio.orig config magisk*.xz</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>Binary Patches
这一步是对二进制文件的patch，boot.img中的二进制文件主要指的是kernel以及对应的dtb文件
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">for</span> dt in dtb kernel_dtb extra<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="o">[</span> -f <span class="nv">$dt</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> ./magiskboot dtb <span class="nv">$dt</span> patch <span class="o">&amp;&amp;</span> ui_print <span class="s2">&#34;- Patch fstab in </span><span class="nv">$dt</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -f kernel <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 专门针对三星设备的patch</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Remove Samsung RKP</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 绕过三星内核保护，参考文章：https://www.anquanke.com/post/id/85627</span>
</span></span><span class="line"><span class="cl">    ./magiskboot hexpatch kernel <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    49010054011440B93FA00F71E9000054010840B93FA00F7189000054001840B91FA00F7188010054 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    A1020054011440B93FA00F7140020054010840B93FA00F71E0010054001840B91FA00F7181010054
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Remove Samsung defex</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 三星设备防护，参考文章：https://www.99mediasector.com/how-to-disable-defex-security-to-root-samsung-galaxy-phones-oreo/</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Before: [mov w2, #-221]   (-__NR_execve)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># After:  [mov w2, #-32768]</span>
</span></span><span class="line"><span class="cl">    ./magiskboot hexpatch kernel 821B8012 E2FF8F12
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Force kernel to load rootfs</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># skip_initramfs -&gt; want_initramfs</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># skip_initramfs属于内核启动参数cmdline中，与system-as-root有关，将skip_initramfs更改为want_initramfs，实际上可以认为是去除skip_initramfs这个参数</span>
</span></span><span class="line"><span class="cl">    ./magiskboot hexpatch kernel <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    736B69705F696E697472616D667300 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    77616E745F696E697472616D667300
</span></span><span class="line"><span class="cl"><span class="k">fi</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>Repack &amp; Flash
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ui_print <span class="s2">&#34;- Repacking boot image&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 上面已经修改好了ramdisk和kernel、dtb，现在开始重新打包成boot.img</span>
</span></span><span class="line"><span class="cl">./magiskboot repack <span class="s2">&#34;</span><span class="nv">$BOOTIMAGE</span><span class="s2">&#34;</span> <span class="o">||</span> abort <span class="s2">&#34;! Unable to repack boot image&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Sign chromeos boot</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CHROMEOS</span> <span class="o">&amp;&amp;</span> sign_chromeos
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Restore the original boot partition path</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span> -e <span class="s2">&#34;</span><span class="nv">$BOOTNAND</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">BOOTIMAGE</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$BOOTNAND</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Reset any error code</span>
</span></span><span class="line"><span class="cl">true</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h5 id="12-magiskboot的作用" class="heading-element"><span>1.2 magiskboot的作用</span>
  <a href="#12-magiskboot%e7%9a%84%e4%bd%9c%e7%94%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><p>boot_patch脚本中多次出现了magiskboot，下面根据上述提到的方法来看看其具体的实现，位置在native/jni/magiskboot</p>
<h6 id="121-main" class="heading-element"><span>1.2.1 main</span>
  <a href="#121-main" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>头文件中定义了boot_patch中所使用到的方法，由main.cpp来处理action</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/magiskboot.hpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define HEADER_FILE     &#34;header&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KERNEL_FILE     &#34;kernel&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RAMDISK_FILE    &#34;ramdisk.cpio&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SECOND_FILE     &#34;second&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EXTRA_FILE      &#34;extra&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KER_DTB_FILE    &#34;kernel_dtb&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RECV_DTBO_FILE  &#34;recovery_dtbo&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DTB_FILE        &#34;dtb&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NEW_BOOT        &#34;new-boot.img&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">unpack</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">skip_decomp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">hdr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">repack</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src_img</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_img</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">skip_comp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">split_image_dtb</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">hexpatch</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">to</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">cpio_commands</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">dtb_commands</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="nf">patch_verity</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="nf">patch_encryption</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">check_env</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/main.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmdline_logging</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Skip &#39;--&#39; for backwards compatibility
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">string_view</span> <span class="n">action</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">str_starts</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="s">&#34;--&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">action</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="s">&#34;cleanup&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&#34;repack&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;-n&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="n">repack</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">?</span> <span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="n">NEW_BOOT</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">repack</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">?</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:</span> <span class="n">NEW_BOOT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&#34;decompress&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">decompress</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">str_starts</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="s">&#34;compress&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">compress</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">:</span> <span class="s">&#34;gzip&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&#34;hexpatch&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hexpatch</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&#34;cpio&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">cpio_commands</span><span class="p">(</span><span class="n">argc</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">argv</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&#34;dtb&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">dtb_commands</span><span class="p">(</span><span class="n">argc</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">argv</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h6 id="122-unpack" class="heading-element"><span>1.2.2 unpack</span>
  <a href="#122-unpack" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>uppack方法依赖于对boot.img镜像的解析得到的boot_img结构体，再根据具体偏移量dump出对应文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/bootimg.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">unpack</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">skip_decomp</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 对传入的boot.img镜像转换成boot_img结构体，当生成boot_img结构体后
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 就可以根据不同类型文件的addr和size来进行文件的dump
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">boot_img</span> <span class="n">boot</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Dump kernel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dump</span><span class="p">(</span><span class="n">boot</span><span class="p">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">boot</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">kernel_size</span><span class="p">(),</span> <span class="n">KERNEL_FILE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Dump kernel_dtb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dump</span><span class="p">(</span><span class="n">boot</span><span class="p">.</span><span class="n">kernel_dtb</span><span class="p">,</span> <span class="n">boot</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">kernel_dt_size</span><span class="p">,</span> <span class="n">KER_DTB_FILE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Dump ramdisk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dump</span><span class="p">(</span><span class="n">boot</span><span class="p">.</span><span class="n">ramdisk</span><span class="p">,</span> <span class="n">boot</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ramdisk_size</span><span class="p">(),</span> <span class="n">RAMDISK_FILE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Dump second
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dump</span><span class="p">(</span><span class="n">boot</span><span class="p">.</span><span class="n">second</span><span class="p">,</span> <span class="n">boot</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">second_size</span><span class="p">(),</span> <span class="n">SECOND_FILE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里着重看看转化成boot_img结构体的过程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/bootimg.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">boot_img</span><span class="o">::</span><span class="n">boot_img</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将boot.img文件映射到只读内存区域，同时会赋值给map_addr和map_size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mmap_ro</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">map_addr</span><span class="p">,</span> <span class="n">map_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Parsing boot image: [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 根据不同文件的magic header来区分
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">map_addr</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">map_addr</span> <span class="o">+</span> <span class="n">map_size</span><span class="p">;</span> <span class="o">++</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 检查文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">format_t</span> <span class="n">fmt</span> <span class="o">=</span> <span class="n">check_fmt</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">map_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">CHROMEOS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// chromeos require external signing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">flags</span><span class="p">[</span><span class="n">CHROMEOS_FLAG</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">addr</span> <span class="o">+=</span> <span class="mi">65535</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DHTB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flags</span><span class="p">[</span><span class="n">DHTB_FLAG</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">flags</span><span class="p">[</span><span class="n">SEANDROID_FLAG</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;DHTB_HDR</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dhtb_hdr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">BLOB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flags</span><span class="p">[</span><span class="n">BLOB_FLAG</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;TEGRA_BLOB</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">blob_hdr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">AOSP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">AOSP_VENDOR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// AOSP为kernel相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">parse_image</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/format.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">format_t</span> <span class="nf">check_fmt</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">CHECKED_MATCH</span><span class="p">(</span><span class="n">CHROMEOS_MAGIC</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">CHROMEOS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECKED_MATCH</span><span class="p">(</span><span class="n">BOOT_MAGIC</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">AOSP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECKED_MATCH</span><span class="p">(</span><span class="n">VENDOR_BOOT_MAGIC</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">AOSP_VENDOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="p">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/format.hpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define BOOT_MAGIC      &#34;ANDROID!&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define VENDOR_BOOT_MAGIC &#34;VNDRBOOT&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CHROMEOS_MAGIC  &#34;CHROMEOS&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define GZIP1_MAGIC     &#34;\x1f\x8b&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define GZIP2_MAGIC     &#34;\x1f\x9e&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LZOP_MAGIC      &#34;\x89&#34;&#34;LZO&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define XZ_MAGIC        &#34;\xfd&#34;&#34;7zXZ&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BZIP_MAGIC      &#34;BZh&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>解析kernel以及ramdisk size的过程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/bootimg.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">boot_img</span><span class="o">::</span><span class="n">parse_image</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">format_t</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 首先获取到boot.img的header结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">hp</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">boot_img_hdr</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AOSP_VENDOR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;VENDOR_BOOT_HDR</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">dyn_img_vnd_v3</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">&gt;=</span> <span class="mh">0x02000000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;PXA_BOOT_HDR</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">dyn_img_pxa</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">......</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 根据header的版本选择对应的处理方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">switch</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">header_version</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">hdr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">dyn_img_v1</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">hdr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">dyn_img_v2</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">hdr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">dyn_img_v3</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">hdr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">dyn_img_v0</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Default to hdr v2，代码仿照android原生bootimg.h，也就是根据官方的逻辑来获取size，参考https://android.googlesource.com/platform/system/tools/mkbootimg/+/refs/heads/master/include/bootimg/bootimg.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">using</span> <span class="n">boot_img_hdr</span> <span class="o">=</span> <span class="n">boot_img_hdr_v2</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>上面可以看到在处理boot.img header阶段时有不同版本的header，截止到android13时boot.img header一共存有5个版本：<a href="https://source.android.com/docs/core/architecture/bootloader/boot-image-header#header-v0"target="_blank" rel="external nofollow noopener noreferrer">Boot Image Header</a>，header之所以会产生迭代是因为boot.img中的文件是一直存在变化的，包括v1版本出现的recovery image，v2版本出现的dtb等等</p>
<p>执行完unpack方法后就得到了boot.img解包后目录，目录下的文件可参考</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/magiskboot.hpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define HEADER_FILE     &#34;header&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KERNEL_FILE     &#34;kernel&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RAMDISK_FILE    &#34;ramdisk.cpio&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SECOND_FILE     &#34;second&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EXTRA_FILE      &#34;extra&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KER_DTB_FILE    &#34;kernel_dtb&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RECV_DTBO_FILE  &#34;recovery_dtbo&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DTB_FILE        &#34;dtb&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NEW_BOOT        &#34;new-boot.img&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><h6 id="123-cpio" class="heading-element"><span>1.2.3 cpio</span>
  <a href="#123-cpio" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>在boot_patch中cpio方法主要使用到的地方在于ramdisk patch，也就是下面这个脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">./magiskboot cpio ramdisk.cpio <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;add 0750 init magiskinit&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;mkdir 0750 overlay.d&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;mkdir 0750 overlay.d/sbin&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;add 0644 overlay.d/sbin/magisk32.xz magisk32.xz&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;</span><span class="nv">$SKIP64</span><span class="s2"> add 0644 overlay.d/sbin/magisk64.xz magisk64.xz&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;patch&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;backup ramdisk.cpio.orig&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;mkdir 000 .backup&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;add 000 .backup/.magisk config&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>cpio的入口是cpio_commands</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;test&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="n">cpio</span><span class="p">.</span><span class="n">test</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;restore&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpio</span><span class="p">.</span><span class="n">restore</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;sha1&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span> <span class="o">=</span> <span class="n">cpio</span><span class="p">.</span><span class="n">sha1</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sha1</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sha1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;compress&#34;</span><span class="n">sv</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpio</span><span class="p">.</span><span class="n">compress</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;decompress&#34;</span><span class="n">sv</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpio</span><span class="p">.</span><span class="n">decompress</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;patch&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpio</span><span class="p">.</span><span class="n">patch</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;exists&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="o">!</span><span class="n">cpio</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;backup&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpio</span><span class="p">.</span><span class="n">backup</span><span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdc</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;rm&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">r</span> <span class="o">=</span> <span class="n">cmdc</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;-r&#34;</span><span class="n">sv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpio</span><span class="p">.</span><span class="n">rm</span><span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">],</span> <span class="n">r</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdc</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;mv&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpio</span><span class="p">.</span><span class="n">mv</span><span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;extract&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cmdc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">!</span><span class="n">cpio</span><span class="p">.</span><span class="n">extract</span><span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cpio</span><span class="p">.</span><span class="n">extract</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdc</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;mkdir&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpio</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">strtoul</span><span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="k">nullptr</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdc</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;ln&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpio</span><span class="p">.</span><span class="n">ln</span><span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cmdc</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;add&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpio</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">strtoul</span><span class="p">(</span><span class="n">cmdv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="k">nullptr</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmdv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>根据cpio给出的指令解析，可以将所执行的shell命令划分为如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="s2">&#34;add 0750 init magiskinit&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;mkdir 0750 overlay.d&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;mkdir 0750 overlay.d/sbin&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;add 0644 overlay.d/sbin/magisk32.xz magisk32.xz&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;add 0644 overlay.d/sbin/magisk64.xz magisk64.xz&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;patch&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;backup ramdisk.cpio.orig&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;mkdir 000 .backup&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;add 000 .backup/.magisk config&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>也就是add、mkdir、patch、backup这几个方法，在执行方法前，会先进行cpio文件的加载</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/ramdisk.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="o">*</span><span class="n">incpio</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="o">++</span><span class="n">argv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">--</span><span class="n">argc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">magisk_cpio</span> <span class="n">cpio</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">incpio</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpio</span><span class="p">.</span><span class="n">load_cpio</span><span class="p">(</span><span class="n">incpio</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// native/jni/utils/cpio.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">cpio_rw</span><span class="o">::</span><span class="n">load_cpio</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">sz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 读取ramdisk到只读内存区域
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mmap_ro</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Loading cpio: [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 加载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">load_cpio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 释放上面的内存区域
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">munmap</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">cpio_rw</span><span class="o">::</span><span class="n">load_cpio</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">sz</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">cpio_newc_header</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">cpio_entry</span><span class="o">&gt;</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">sz</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">header</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">cpio_newc_header</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span> <span class="o">=</span> <span class="n">make_unique</span><span class="o">&lt;</span><span class="n">cpio_entry</span><span class="o">&gt;</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">string_view</span> <span class="nf">name_view</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pos</span> <span class="o">+=</span> <span class="n">x8u</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">namesize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pos_align</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">name_view</span> <span class="o">==</span> <span class="s">&#34;.&#34;</span> <span class="o">||</span> <span class="n">name_view</span> <span class="o">==</span> <span class="s">&#34;..&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">name_view</span> <span class="o">==</span> <span class="s">&#34;TRAILER!!!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">name_view</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">filesize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">filesize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pos</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">filesize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这步是关键，等于是将文件都存入数据当中，便于后续来做替换以及插入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">entries</span><span class="p">[</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pos_align</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>load完成之后，得到了magisk_cpio的实例，下面就可以根据脚本来进行patch</p>
<ul>
<li>add
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/utils/cpio.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">cpio_rw</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">mode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">sz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 映射到只读区域
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mmap_ro</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建entry对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cpio_entry</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 配置属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">e</span><span class="o">-&gt;</span><span class="n">filesize</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将buf存入data属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">munmap</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 插入ramdisk中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">insert</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Add entry [%s] (%04o)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">cpio_rw</span><span class="o">::</span><span class="n">insert</span><span class="p">(</span><span class="n">cpio_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 判断文件是否存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">entries</span><span class="p">.</span><span class="n">extract</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 存在即替换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">entries</span><span class="p">[</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">].</span><span class="n">reset</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 不存在直接插入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ex</span><span class="p">.</span><span class="n">key</span><span class="p">()</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ex</span><span class="p">.</span><span class="n">mapped</span><span class="p">().</span><span class="n">reset</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">entries</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">ex</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>mkdir
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 类似linux mkdir
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">cpio_rw</span><span class="o">::</span><span class="n">mkdir</span><span class="p">(</span><span class="n">mode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">insert</span><span class="p">(</span><span class="k">new</span> <span class="n">cpio_entry</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFDIR</span> <span class="o">|</span> <span class="n">mode</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Create directory [%s] (%04o)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>patch
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 根据传入的KEEPVERITY等来判断是否解fstab锁，默认是需要解锁的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">magisk_cpio</span><span class="o">::</span><span class="n">patch</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">keepverity</span> <span class="o">=</span> <span class="n">check_env</span><span class="p">(</span><span class="s">&#34;KEEPVERITY&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">keepforceencrypt</span> <span class="o">=</span> <span class="n">check_env</span><span class="p">(</span><span class="s">&#34;KEEPFORCEENCRYPT&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Patch with flag KEEPVERITY=[%s] KEEPFORCEENCRYPT=[%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">keepverity</span> <span class="o">?</span> <span class="s">&#34;true&#34;</span> <span class="o">:</span> <span class="s">&#34;false&#34;</span><span class="p">,</span> <span class="n">keepforceencrypt</span> <span class="o">?</span> <span class="s">&#34;true&#34;</span> <span class="o">:</span> <span class="s">&#34;false&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">entries</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">entries</span><span class="p">.</span><span class="n">end</span><span class="p">();)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">it</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">fstab</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">keepverity</span> <span class="o">||</span> <span class="o">!</span><span class="n">keepforceencrypt</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">S_ISREG</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">!</span><span class="n">str_starts</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span> <span class="s">&#34;.backup&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">!</span><span class="n">str_contains</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span> <span class="s">&#34;twrp&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">!</span><span class="n">str_contains</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span> <span class="s">&#34;recovery&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">str_contains</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span> <span class="s">&#34;fstab&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">keepverity</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">fstab</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Found fstab file [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">cur</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">filesize</span> <span class="o">=</span> <span class="n">patch_verity</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">filesize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">==</span> <span class="s">&#34;verity_key&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">rm</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">keepforceencrypt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">fstab</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">cur</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">filesize</span> <span class="o">=</span> <span class="n">patch_encryption</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">filesize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>backup
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/ramdisk.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">magisk_cpio</span><span class="o">::</span><span class="n">backup</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">orig</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry_map</span> <span class="n">bkup_entries</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">string</span> <span class="n">remv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 新建.backup目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">cpio_entry</span><span class="p">(</span><span class="s">&#34;.backup&#34;</span><span class="p">,</span> <span class="n">S_IFDIR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">bkup_entries</span><span class="p">[</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">].</span><span class="n">reset</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">magisk_cpio</span> <span class="nf">o</span><span class="p">(</span><span class="n">orig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 删除原有ramdisk可能存有的.backup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Remove possible backups in original ramdisk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">o</span><span class="p">.</span><span class="n">rm</span><span class="p">(</span><span class="s">&#34;.backup&#34;</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rm</span><span class="p">(</span><span class="s">&#34;.backup&#34;</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这里分别取原生的ramdisk以及刚刚patch的ramdisk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">lhs</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">entries</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">rhs</span> <span class="o">=</span> <span class="n">entries</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">lhs</span> <span class="o">!=</span> <span class="n">o</span><span class="p">.</span><span class="n">entries</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">||</span> <span class="n">rhs</span> <span class="o">!=</span> <span class="n">entries</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">backup</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">lhs</span> <span class="o">!=</span> <span class="n">o</span><span class="p">.</span><span class="n">entries</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">rhs</span> <span class="o">!=</span> <span class="n">entries</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="n">rhs</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">lhs</span> <span class="o">==</span> <span class="n">o</span><span class="p">.</span><span class="n">entries</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Something is missing in new ramdisk, backup!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">backup</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Backup missing entry: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 这里表示发现两者不一样的地方，特别针对init文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">filesize</span> <span class="o">!=</span> <span class="n">rhs</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">filesize</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="n">memcmp</span><span class="p">(</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rhs</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">lhs</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">filesize</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Not the same!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">backup</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Backup mismatch entry: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Something new in ramdisk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">remv</span> <span class="o">+=</span> <span class="n">rhs</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">remv</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Record new entry: [%s] -&gt; [.backup/.rmlist]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">rhs</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">backup</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 将init等文件放在.backup目录下
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">string</span> <span class="nf">back_name</span><span class="p">(</span><span class="s">&#34;.backup/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">back_name</span> <span class="o">+=</span> <span class="n">lhs</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;[%s] -&gt; [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lhs</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">back_name</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">ex</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">cpio_entry</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">lhs</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">release</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">ex</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">back_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">bkup_entries</span><span class="p">[</span><span class="n">ex</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">].</span><span class="n">reset</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>结合一开始提到的那段shell命令，可以看出在ramdisk patch这个阶段所做的是就是</p>
<ol>
<li>使用定制的magiskinit替换原生init</li>
<li>创建overlay.d/sbin目录并将定制的magisk复制到目录下</li>
<li>解锁fstab</li>
<li>备份ramdisk，主要为了备份init</li>
<li>创建.backup并将config配置文件复制到目录下</li>
</ol>
<h6 id="124-dtb" class="heading-element"><span>1.2.4 dtb</span>
  <a href="#124-dtb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>dtb的部分是为了要去除fsmgr_flags的校验</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/dtb.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">bool</span> <span class="nf">dtb_patch</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">keep_verity</span> <span class="o">=</span> <span class="n">check_env</span><span class="p">(</span><span class="s">&#34;KEEPVERITY&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">dtb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Loading dtbs from [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mmap_rw</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dtb</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">patched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="o">*</span> <span class="k">const</span> <span class="n">end</span> <span class="o">=</span> <span class="n">dtb</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">fdt</span> <span class="o">=</span> <span class="n">dtb</span><span class="p">;</span> <span class="n">fdt</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fdt</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">memmem</span><span class="p">(</span><span class="n">fdt</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">fdt</span><span class="p">,</span> <span class="n">DTB_MAGIC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fdt32_t</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">fdt</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="kt">int</span> <span class="n">fstab</span> <span class="o">=</span> <span class="n">find_fstab</span><span class="p">(</span><span class="n">fdt</span><span class="p">);</span> <span class="n">fstab</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">fdt_for_each_subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">fdt</span><span class="p">,</span> <span class="n">fstab</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">keep_verity</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fdt_getprop</span><span class="p">(</span><span class="n">fdt</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="s">&#34;fsmgr_flags&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">patched</span> <span class="o">|=</span> <span class="n">patch_verity</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">fdt</span> <span class="o">+=</span> <span class="n">fdt_totalsize</span><span class="p">(</span><span class="n">fdt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">munmap</span><span class="p">(</span><span class="n">dtb</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">patched</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h6 id="125-hexpatch" class="heading-element"><span>1.2.5 hexpatch</span>
  <a href="#125-hexpatch" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/magiskboot/hexpatch.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1">// 原理就是根据传入的hex来做替换
</span></span></span></code></pre></td></tr></table>
</div>
</div><h6 id="126-repack" class="heading-element"><span>1.2.6 repack</span>
  <a href="#126-repack" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>略</p>
<h6 id="127-patch示例" class="heading-element"><span>1.2.7 patch示例</span>
  <a href="#127-patch%e7%a4%ba%e4%be%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>以miui12的boot.img作为示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">- Unpacking boot image
</span></span><span class="line"><span class="cl">Parsing boot image: <span class="o">[</span>boot.img<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># header版本</span>
</span></span><span class="line"><span class="cl">HEADER_VER      <span class="o">[</span>2<span class="o">]</span>
</span></span><span class="line"><span class="cl">KERNEL_SZ       <span class="o">[</span>11561996<span class="o">]</span>
</span></span><span class="line"><span class="cl">RAMDISK_SZ      <span class="o">[</span>20066474<span class="o">]</span>
</span></span><span class="line"><span class="cl">SECOND_SZ       <span class="o">[</span>0<span class="o">]</span>
</span></span><span class="line"><span class="cl">RECOV_DTBO_SZ   <span class="o">[</span>0<span class="o">]</span>
</span></span><span class="line"><span class="cl">DTB_SZ          <span class="o">[</span>123999<span class="o">]</span>
</span></span><span class="line"><span class="cl">OS_VERSION      <span class="o">[</span>11.0.0<span class="o">]</span>
</span></span><span class="line"><span class="cl">OS_PATCH_LEVEL  <span class="o">[</span>2022-02<span class="o">]</span>
</span></span><span class="line"><span class="cl">PAGESIZE        <span class="o">[</span>2048<span class="o">]</span>
</span></span><span class="line"><span class="cl">NAME            <span class="o">[]</span>
</span></span><span class="line"><span class="cl">CMDLINE         <span class="o">[</span><span class="nv">bootopt</span><span class="o">=</span>64S3,32N2,64N2<span class="o">]</span>
</span></span><span class="line"><span class="cl">CHECKSUM        <span class="o">[</span>1c7765429e25833c9a109589cfe6ead8d89bf819000000000000000000000000<span class="o">]</span>
</span></span><span class="line"><span class="cl">KERNEL_DTB_SZ   <span class="o">[</span>123999<span class="o">]</span>
</span></span><span class="line"><span class="cl">KERNEL_FMT      <span class="o">[</span>gzip<span class="o">]</span>
</span></span><span class="line"><span class="cl">RAMDISK_FMT     <span class="o">[</span>gzip<span class="o">]</span>
</span></span><span class="line"><span class="cl">VBMETA
</span></span><span class="line"><span class="cl">- Checking ramdisk status
</span></span><span class="line"><span class="cl">Loading cpio: <span class="o">[</span>ramdisk.cpio<span class="o">]</span>
</span></span><span class="line"><span class="cl">- Stock boot image detected
</span></span><span class="line"><span class="cl">- Patching ramdisk
</span></span><span class="line"><span class="cl">// ramdisk patch部分
</span></span><span class="line"><span class="cl">Loading cpio: <span class="o">[</span>ramdisk.cpio<span class="o">]</span>
</span></span><span class="line"><span class="cl">Add entry <span class="o">[</span>init<span class="o">]</span> <span class="o">(</span>0750<span class="o">)</span>
</span></span><span class="line"><span class="cl">Create directory <span class="o">[</span>overlay.d<span class="o">]</span> <span class="o">(</span>0750<span class="o">)</span>
</span></span><span class="line"><span class="cl">Create directory <span class="o">[</span>overlay.d/sbin<span class="o">]</span> <span class="o">(</span>0750<span class="o">)</span>
</span></span><span class="line"><span class="cl">Add entry <span class="o">[</span>overlay.d/sbin/magisk32.xz<span class="o">]</span> <span class="o">(</span>0644<span class="o">)</span>
</span></span><span class="line"><span class="cl">Add entry <span class="o">[</span>overlay.d/sbin/magisk64.xz<span class="o">]</span> <span class="o">(</span>0644<span class="o">)</span>
</span></span><span class="line"><span class="cl">Patch with flag <span class="nv">KEEPVERITY</span><span class="o">=[</span>false<span class="o">]</span> <span class="nv">KEEPFORCEENCRYPT</span><span class="o">=[</span>false<span class="o">]</span>
</span></span><span class="line"><span class="cl">Found fstab file <span class="o">[</span>first_stage_ramdisk/fstab.mt6768<span class="o">]</span>
</span></span><span class="line"><span class="cl">Remove pattern <span class="o">[</span>,avb<span class="o">=</span>vbmeta_system<span class="o">]</span>
</span></span><span class="line"><span class="cl">Remove pattern <span class="o">[</span>,avb_keys<span class="o">=</span>/avb/q-gsi.avbpubkey:/avb/r-gsi.avbpubkey:/avb/s-gsi.avbpubkey<span class="o">]</span>
</span></span><span class="line"><span class="cl">Remove pattern <span class="o">[</span>,avb<span class="o">]</span>
</span></span><span class="line"><span class="cl">Remove pattern <span class="o">[</span>,avb<span class="o">]</span>
</span></span><span class="line"><span class="cl">Remove pattern <span class="o">[</span>,avb<span class="o">=</span>vbmeta<span class="o">]</span>
</span></span><span class="line"><span class="cl">Remove pattern <span class="o">[</span>,fileencryption<span class="o">=</span>aes-256-xts:aes-256-cts:v2<span class="o">]</span>
</span></span><span class="line"><span class="cl">Found fstab file <span class="o">[</span>miui.factoryreset.fstab<span class="o">]</span>
</span></span><span class="line"><span class="cl">Remove pattern <span class="o">[</span>,fsverity<span class="o">]</span>
</span></span><span class="line"><span class="cl">Remove pattern <span class="o">[</span>,fileencryption<span class="o">=</span>aes-256-xts:aes-256-cts:v2+inlinecrypt_optimized<span class="o">]</span>
</span></span><span class="line"><span class="cl">Remove <span class="o">[</span>verity_key<span class="o">]</span>
</span></span><span class="line"><span class="cl">Loading cpio: <span class="o">[</span>ramdisk.cpio.orig<span class="o">]</span>
</span></span><span class="line"><span class="cl">// backup ramdisk.cpio.orig部分，对未同步的再做一次备份
</span></span><span class="line"><span class="cl">Backup mismatch entry: <span class="o">[</span>first_stage_ramdisk/fstab.mt6768<span class="o">]</span> -&gt; <span class="o">[</span>.backup/first_stage_ramdisk/fstab.mt6768<span class="o">]</span>
</span></span><span class="line"><span class="cl">Backup mismatch entry: <span class="o">[</span>init<span class="o">]</span> -&gt; <span class="o">[</span>.backup/init<span class="o">]</span>
</span></span><span class="line"><span class="cl">Backup mismatch entry: <span class="o">[</span>miui.factoryreset.fstab<span class="o">]</span> -&gt; <span class="o">[</span>.backup/miui.factoryreset.fstab<span class="o">]</span>
</span></span><span class="line"><span class="cl">Record new entry: <span class="o">[</span>overlay.d<span class="o">]</span> -&gt; <span class="o">[</span>.backup/.rmlist<span class="o">]</span>
</span></span><span class="line"><span class="cl">Record new entry: <span class="o">[</span>overlay.d/sbin<span class="o">]</span> -&gt; <span class="o">[</span>.backup/.rmlist<span class="o">]</span>
</span></span><span class="line"><span class="cl">Record new entry: <span class="o">[</span>overlay.d/sbin/magisk32.xz<span class="o">]</span> -&gt; <span class="o">[</span>.backup/.rmlist<span class="o">]</span>
</span></span><span class="line"><span class="cl">Record new entry: <span class="o">[</span>overlay.d/sbin/magisk64.xz<span class="o">]</span> -&gt; <span class="o">[</span>.backup/.rmlist<span class="o">]</span>
</span></span><span class="line"><span class="cl">Backup missing entry: <span class="o">[</span>verity_key<span class="o">]</span> -&gt; <span class="o">[</span>.backup/verity_key<span class="o">]</span>
</span></span><span class="line"><span class="cl">Create directory <span class="o">[</span>.backup<span class="o">]</span> <span class="o">(</span>0000<span class="o">)</span>
</span></span><span class="line"><span class="cl">Add entry <span class="o">[</span>.backup/.magisk<span class="o">]</span> <span class="o">(</span>0000<span class="o">)</span>
</span></span><span class="line"><span class="cl">Dump cpio: <span class="o">[</span>ramdisk.cpio<span class="o">]</span>
</span></span><span class="line"><span class="cl">Loading dtbs from <span class="o">[</span>dtb<span class="o">]</span>
</span></span><span class="line"><span class="cl">Loading dtbs from <span class="o">[</span>kernel_dtb<span class="o">]</span>
</span></span><span class="line"><span class="cl">// patch skip_参数
</span></span><span class="line"><span class="cl">Patch @ 017950F8 <span class="o">[</span>736B69705F696E697472616D667300<span class="o">]</span> -&gt; <span class="o">[</span>77616E745F696E697472616D667300<span class="o">]</span>
</span></span><span class="line"><span class="cl">- Repacking boot image
</span></span><span class="line"><span class="cl">Parsing boot image: <span class="o">[</span>boot.img<span class="o">]</span>
</span></span><span class="line"><span class="cl">HEADER_VER      <span class="o">[</span>2<span class="o">]</span>
</span></span><span class="line"><span class="cl">KERNEL_SZ       <span class="o">[</span>11561996<span class="o">]</span>
</span></span><span class="line"><span class="cl">RAMDISK_SZ      <span class="o">[</span>20066474<span class="o">]</span>
</span></span><span class="line"><span class="cl">SECOND_SZ       <span class="o">[</span>0<span class="o">]</span>
</span></span><span class="line"><span class="cl">RECOV_DTBO_SZ   <span class="o">[</span>0<span class="o">]</span>
</span></span><span class="line"><span class="cl">DTB_SZ          <span class="o">[</span>123999<span class="o">]</span>
</span></span><span class="line"><span class="cl">OS_VERSION      <span class="o">[</span>11.0.0<span class="o">]</span>
</span></span><span class="line"><span class="cl">OS_PATCH_LEVEL  <span class="o">[</span>2022-02<span class="o">]</span>
</span></span><span class="line"><span class="cl">PAGESIZE        <span class="o">[</span>2048<span class="o">]</span>
</span></span><span class="line"><span class="cl">NAME            <span class="o">[]</span>
</span></span><span class="line"><span class="cl">CMDLINE         <span class="o">[</span><span class="nv">bootopt</span><span class="o">=</span>64S3,32N2,64N2<span class="o">]</span>
</span></span><span class="line"><span class="cl">CHECKSUM        <span class="o">[</span>1c7765429e25833c9a109589cfe6ead8d89bf819000000000000000000000000<span class="o">]</span>
</span></span><span class="line"><span class="cl">KERNEL_DTB_SZ   <span class="o">[</span>123999<span class="o">]</span>
</span></span><span class="line"><span class="cl">KERNEL_FMT      <span class="o">[</span>gzip<span class="o">]</span>
</span></span><span class="line"><span class="cl">RAMDISK_FMT     <span class="o">[</span>gzip<span class="o">]</span>
</span></span><span class="line"><span class="cl">VBMETA
</span></span><span class="line"><span class="cl">Repack to boot image: <span class="o">[</span>new-boot.img<span class="o">]</span>
</span></span><span class="line"><span class="cl">HEADER_VER      <span class="o">[</span>2<span class="o">]</span>
</span></span><span class="line"><span class="cl">KERNEL_SZ       <span class="o">[</span>11567292<span class="o">]</span>
</span></span><span class="line"><span class="cl">RAMDISK_SZ      <span class="o">[</span>23699677<span class="o">]</span>
</span></span><span class="line"><span class="cl">SECOND_SZ       <span class="o">[</span>0<span class="o">]</span>
</span></span><span class="line"><span class="cl">RECOV_DTBO_SZ   <span class="o">[</span>0<span class="o">]</span>
</span></span><span class="line"><span class="cl">DTB_SZ          <span class="o">[</span>123999<span class="o">]</span>
</span></span><span class="line"><span class="cl">OS_VERSION      <span class="o">[</span>11.0.0<span class="o">]</span>
</span></span><span class="line"><span class="cl">OS_PATCH_LEVEL  <span class="o">[</span>2022-02<span class="o">]</span>
</span></span><span class="line"><span class="cl">PAGESIZE        <span class="o">[</span>2048<span class="o">]</span>
</span></span><span class="line"><span class="cl">NAME            <span class="o">[]</span>
</span></span><span class="line"><span class="cl">CMDLINE         <span class="o">[</span><span class="nv">bootopt</span><span class="o">=</span>64S3,32N2,64N2<span class="o">]</span>
</span></span><span class="line"><span class="cl">CHECKSUM        <span class="o">[</span>69cf38b1a7b67f4d26f25b8fe87cbaee29dcf565000000000000000000000000<span class="o">]</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="13-patch-boot流程图" class="heading-element"><span>1.3 patch boot流程图</span>
  <a href="#13-patch-boot%e6%b5%81%e7%a8%8b%e5%9b%be" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><p><img loading="lazy" src="https://p3.ssl.qhimg.com/t0129e32587c753c2f5.jpg" alt="https://p3.ssl.qhimg.com/t0129e32587c753c2f5.jpg" srcset="https://p3.ssl.qhimg.com/t0129e32587c753c2f5.jpg?size=small, https://p3.ssl.qhimg.com/t0129e32587c753c2f5.jpg?size=medium 1.5x, https://p3.ssl.qhimg.com/t0129e32587c753c2f5.jpg?size=large 2x" data-title="https://p3.ssl.qhimg.com/t0129e32587c753c2f5.jpg" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>patch boot阶段整体的流程就可以归结为上图，patch点主要在于ramdisk，更精确一点可以说是对init的修改，这里其实是Magisk的很关键一步，围绕boot.img的修改，没有动system.img，所以也就有了Magisk一直宣传的“systemless”的概念，当然，想要完整实现“systemless”还需要依赖于后面booting process过程中对于system的修改</p>
<p>另一方面，可以看出对boot的patch操作可以不仅仅局限于Magisk Manager，只需要准备好资源即可，参照github: magisk patch</p>
<h4 id="2-booting-process" class="heading-element"><span>2 booting process</span>
  <a href="#2-booting-process" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><h5 id="21-android启动方式的演变" class="heading-element"><span>2.1 android启动方式的演变</span>
  <a href="#21-android%e5%90%af%e5%8a%a8%e6%96%b9%e5%bc%8f%e7%9a%84%e6%bc%94%e5%8f%98" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><p>首先是一些术语的解释：</p>
<ul>
<li>rootdir：根目录，所有文件、文件夹或文件系统都存储在rootdir中或挂载在rootdir下。在Android上，rootdir可以是rootfs或system</li>
<li>initramfs：android boot.img中的一部分，内核会将它处理成rootfs，更常见的说法是ramdisk</li>
<li>recovery/boot partition：这两个分区都包含了ramdisk以及kernel，不同的是一个是正常启动到android环境，另一个则是引导到recovery模式</li>
<li>SAR：system-as-root机制，也就是将system分区挂载成rootdir，而不是rootfs</li>
<li>2SI：两阶段初始化，在android10之后被启用</li>
</ul>
<blockquote>
<p>参考<a href="https://topjohnwu.github.io/Magisk/boot.html"target="_blank" rel="external nofollow noopener noreferrer">Magisk官方文档</a></p></blockquote>
<p>android的启动方式演变到现在可以归结为三类：</p>
<table>
  <thead>
      <tr>
          <th>Method</th>
          <th>Initial rootdir</th>
          <th>Final rootdir</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>A</td>
          <td>rootfs</td>
          <td>rootfs</td>
      </tr>
      <tr>
          <td>B</td>
          <td>system</td>
          <td>system</td>
      </tr>
      <tr>
          <td>C</td>
          <td>rootfs</td>
          <td>system</td>
      </tr>
  </tbody>
</table>
<h6 id="211-method-a---传统的ramdisk" class="heading-element"><span>2.1.1 Method A - 传统的ramdisk</span>
  <a href="#211-method-a---%e4%bc%a0%e7%bb%9f%e7%9a%84ramdisk" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>最初版本android启动方式，使用的boot.img header还是最原始版本的，内核将initramfs作为rootdir，同时执行其内部的init文件来启动进而挂载system、userdata等其他分区</p>
<p>这个时期大概是android7.0之前，也就是没有出现A/B分区之前，还存在着recovery分区，recovery分区中也同样具备相同的kernel和独有的ramdisk-recovery</p>
<h6 id="212-method-b---传统的sar机制" class="heading-element"><span>2.1.2 Method B - 传统的SAR机制</span>
  <a href="#212-method-b---%e4%bc%a0%e7%bb%9f%e7%9a%84sar%e6%9c%ba%e5%88%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>android7.0之后，android推出了system-as-root机制，也就是将system分区作为rootdir（这样做的原因是希望将rootdir和android平台绑定，而不是让rootdir和厂商相关部分绑定，厂商部分可以通过修改vendor等定制分区），同时执行其内部的init文件，这样做也导致boot.img中的ramdisk变得无用，因此移除了recovery分区并将其ramdisk-recovery放在boot.img当中</p>
<p>另一方面，system由于是Android sparse image格式没办法直接挂载，通常会处理成ext4再挂载到system_root上，之前在patch binary的时候提到过skip_initramfs参数，这个参数是用来表示是否加载initramfs到rootfs，如果没有这个参数，则直接会加载ramdisk到rootfs，也就是进入了recovery模式</p>
<h6 id="212-method-c---两阶段初始化ramdisk-to-sar" class="heading-element"><span>2.1.2 Method C - 两阶段初始化（ramdisk to SAR）</span>
  <a href="#212-method-c---%e4%b8%a4%e9%98%b6%e6%ae%b5%e5%88%9d%e5%a7%8b%e5%8c%96ramdisk-to-sar" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>android10之后要求各大厂商都必须要使用two-stage-init的模式，可以从源码中看看处理流程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// /system/core/init/main.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s">&#34;ueventd&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ueventd_main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;subcontext&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">InitLogging</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">KernelLogger</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">BuiltinFunctionMap</span><span class="o">&amp;</span> <span class="n">function_map</span> <span class="o">=</span> <span class="n">GetBuiltinFunctionMap</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">SubcontextMain</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;selinux_setup&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">SetupSelinux</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;second_stage&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">SecondStageMain</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 在没有任务参数的情况下，会走FirstStageMain方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">FirstStageMain</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个阶段内核会将rootfs作为rootdir，执行init进程走FirstStageMain方法，而它所做的工作就是挂载system分区并将它作为新的rootdir</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">FirstStageMain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 挂载分区、挂载/dev、/proc、sys/fs/selinux
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">......</span>
</span></span><span class="line"><span class="cl">    <span class="n">InitKernelLogging</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DoFirstStageMount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 向下引导走
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&#34;/system/bin/init&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span><span class="p">,</span> <span class="s">&#34;selinux_setup&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/kmsg&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">STDOUT_FILENO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">STDERR_FILENO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">execv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">**&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">SetupSelinux</span><span class="p">(</span><span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SetStdioToDevNull</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">InitKernelLogging</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">MountMissingSystemPartitions</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1">// Set up SELinux, loading the SELinux policy.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SelinuxSetupKernelLogging</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">SelinuxInitialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">selinux_android_restorecon</span><span class="p">(</span><span class="s">&#34;/system/bin/init&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PLOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;restorecon failed of /system/bin/init failed&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&#34;/system/bin/init&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span><span class="p">,</span> <span class="s">&#34;second_stage&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">execv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">**&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出，当system分区挂载完成之后，FirstStageMain会通过execv带着selinux_setup执行/system/bin/init从而引导出第二阶段的init，接下来就有system中的init去执行剩余的步骤，包括解释执行init.rc等等</p>
<p>注意：第一阶段使用的是ramdisk-recovery中的init，它其实是system中的init的一个软链</p>
<p>以上就是有关于android启动方式的演变，正是由于这么多复杂的启动方式，也就意味着Magisk为了适配全量机型以及其systemless的特性，就要分别对这些场景进行归类处理</p>
<h5 id="22-magiskinit的处理" class="heading-element"><span>2.2 magiskinit的处理</span>
  <a href="#22-magiskinit%e7%9a%84%e5%a4%84%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/init/init.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1">// 多次进入main方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">......</span>
</span></span><span class="line"><span class="cl">    <span class="n">BaseInit</span> <span class="o">*</span><span class="n">init</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmdline</span> <span class="n">cmd</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 使用参数selinux_setup调用init，表明第一阶段已经完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;selinux_setup&#34;</span><span class="n">sv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">setup_klog</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">init</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SecondStageInit</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// This will also mount /sys and /proc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 解析cmd命令，cmd命令可以从/proc/cmdline中看到
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">load_kernel_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 具体场景区分
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">skip_initramfs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">init</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SARInit</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">force_normal_boot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">init</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FirstStageInit</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/sbin/recovery&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">access</span><span class="p">(</span><span class="s">&#34;/system/bin/recovery&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">init</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecoveryInit</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_two_stage</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">init</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FirstStageInit</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">init</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RootFSInit</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 确定好init类型后执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Run the main routine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">init</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><table>
  <thead>
      <tr>
          <th>Type</th>
          <th>Boot Method</th>
          <th>Partition</th>
          <th>2SI</th>
          <th>Ramdisk in boot</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>I</td>
          <td>A</td>
          <td>A-only</td>
          <td>No</td>
          <td>boot ramdisk</td>
          <td></td>
      </tr>
      <tr>
          <td>II</td>
          <td>B</td>
          <td>A/B</td>
          <td>Any</td>
          <td>recovery ramdisk</td>
          <td></td>
      </tr>
      <tr>
          <td>III</td>
          <td>B</td>
          <td>A-only</td>
          <td>Any</td>
          <td>N/A</td>
          <td></td>
      </tr>
      <tr>
          <td>IV</td>
          <td>C</td>
          <td>Any</td>
          <td>Yes</td>
          <td>Hybrid ramdisk</td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>上面的表格是Magisk会区分的四种场景</p>
<ul>
<li>Type I
<ul>
<li>如果要启动的是正常系统，那么会归入最后一种情况进入到init = new RootFSInit(argv, &amp;cmd)</li>
<li>如果要启动的是recovery模式，由于recovery分区并未被magisk修改，直接从recovery分区启动即可</li>
</ul>
</li>
<li>Type II
<ul>
<li>如果要启动的是正常系统，由于存在命令行参数skip_initramfs，会进入到init = new SARInit(argv, &amp;cmd)</li>
<li>如果要启动的是recovery模式，不会存在skip_initramfs参数，但由于boot.img中的ramdisk是ramdisk-recovery.img，所以会有/sbin/recovery或者/system/bin/recovery文件，进入到init = new RecoveryInit(argv, &amp;cmd)</li>
</ul>
</li>
<li>Type III
<ul>
<li>如果要启动的是正常系统,直接进入无magisk的原始系统</li>
<li>如果要启动的是recovery模式，会导致magiskinit执行，magiskinit读取/.backup/.magisk配置文件得到RECOVERYMODE=true知道它自己是在recovery分区启动，它会调用check_key_combo()判断是否长按音量键上，如果长按则进入magisk系统，否则进入到原来的recovery系统。进入magisk系统仍然进入到init = new SARInit(argv, &amp;cmd)，进入recovery模式会进入init = new RecoveryInit(argv, &amp;cmd)</li>
</ul>
</li>
<li>Type IV
<ul>
<li>如果要启动的是正常系统,由于有很多新的配置是随着Method C出现的,如force_normal_boot,/apex目录,所以会通过判断进入到init = new FirstStageInit(argv, &amp;cmd)</li>
<li>如果要启动的是recovery模式,由于存在/system/bin/init文件。仍然会进入到init = new FirstStageInit(argv, &amp;cmd)</li>
</ul>
</li>
</ul>
<p>具体来看下各个阶段的做法，先从最原始的流程开始看起</p>
<h6 id="221-rootfsinit" class="heading-element"><span>2.2.1 RootFSInit</span>
  <a href="#221-rootfsinit" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>RootFSInit方式是Magisk基于最原始的android启动流程来开发的，可以让我们更好的了解最开始在没有复杂的init流程和rootdir的场景下的执行流程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/************
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Initramfs
</span></span></span><span class="line"><span class="cl"><span class="cm"> ************/</span>
</span></span><span class="line"><span class="cl"><span class="c1">// native/jni/init/init.hpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">RootFSInit</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MagiskInit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">early_mount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">patch_rootfs</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">RootFSInit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[],</span> <span class="n">cmdline</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">:</span> <span class="n">MagiskInit</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">start</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">early_mount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">patch_rootfs</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">exec_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div><p>最原始的启动方式会分为三步：</p>
<ul>
<li>early_mount</li>
<li>patch_rootfs</li>
<li>exec_init</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/init/mount.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1">// 真正挂载rootfs之前的准备工作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">RootFSInit</span><span class="o">::</span><span class="n">early_mount</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 把init文件映射到内存，这个时候init文件在ramdisk patch的时候已经被替换成magiskinit了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">self</span> <span class="o">=</span> <span class="n">mmap_data</span><span class="o">::</span><span class="n">ro</span><span class="p">(</span><span class="s">&#34;/init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Restoring /init</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 同时把备份的init替换当前的init，意味着将init换回原生init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 这一步是为了让exec_init阶段能够继续执行原生init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rename</span><span class="p">(</span><span class="s">&#34;/.backup/init&#34;</span><span class="p">,</span> <span class="s">&#34;/init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 根据devicetree来挂载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mount_with_dt</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">MagiskInit</span><span class="o">::</span><span class="n">mount_with_dt</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">vector</span><span class="o">&lt;</span><span class="n">fstab_entry</span><span class="o">&gt;</span> <span class="n">fstab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 读取fstab文件中的挂载信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">read_dt_fstab</span><span class="p">(</span><span class="n">fstab</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">entry</span> <span class="p">:</span> <span class="n">fstab</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">is_lnk</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">mnt_point</span><span class="p">.</span><span class="n">data</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Derive partname from dev
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">sprintf</span><span class="p">(</span><span class="n">blk_info</span><span class="p">.</span><span class="n">partname</span><span class="p">,</span> <span class="s">&#34;%s%s&#34;</span><span class="p">,</span> <span class="n">basename</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">data</span><span class="p">()),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建块文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">setup_block</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建挂载目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">xmkdir</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">mnt_point</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 执行只读挂载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">xmount</span><span class="p">(</span><span class="n">blk_info</span><span class="p">.</span><span class="n">block_dev</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">mnt_point</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">entry</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">MS_RDONLY</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 同时在mount_list中添加一个挂载点记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">mount_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">mnt_point</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">BaseInit</span><span class="o">::</span><span class="n">read_dt_fstab</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">fstab_entry</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">fstab</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// dt_dir来自于内核cmdline中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// dt_dir赋值是在根据key：androidboot.android_dt_dir来的，如果没有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 默认为/proc/device-tree/firmware/android
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dt_dir</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">cwd</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">getcwd</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cwd</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 切换到目录下
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">chdir</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dt_dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">run_finally</span> <span class="nf">cd</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]{</span> <span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">);</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 没有fstab的话退出，在android10+的设备上已经没有/proc/device-tree的目录了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;fstab&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 切换到fstab目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">chdir</span><span class="p">(</span><span class="s">&#34;fstab&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Make sure dt fstab is enabled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 读取status文件看是否fstab都已经准备就绪
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;status&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">status</span> <span class="o">=</span> <span class="n">rtrim</span><span class="p">(</span><span class="n">full_read</span><span class="p">(</span><span class="s">&#34;status&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="s">&#34;okay&#34;</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="s">&#34;ok&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">xopen_dir</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 根据fstab目录下的挂载信息来加载到fstab列表中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">dirent</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span> <span class="p">(</span><span class="n">dp</span> <span class="o">=</span> <span class="n">xreaddir</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">get</span><span class="p">()));)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_type</span> <span class="o">!=</span> <span class="n">DT_DIR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">chdir</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_finally</span> <span class="nf">f</span><span class="p">([]{</span> <span class="n">chdir</span><span class="p">(</span><span class="s">&#34;..&#34;</span><span class="p">);</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;status&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">auto</span> <span class="n">status</span> <span class="o">=</span> <span class="n">rtrim</span><span class="p">(</span><span class="n">full_read</span><span class="p">(</span><span class="s">&#34;status&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="s">&#34;okay&#34;</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="s">&#34;ok&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">fstab_entry</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">read_info</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_info</span><span class="p">(</span><span class="n">mnt_point</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">entry</span><span class="p">.</span><span class="n">mnt_point</span> <span class="o">=</span> <span class="s">&#34;/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">entry</span><span class="p">.</span><span class="n">mnt_point</span> <span class="o">+=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_info</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_info</span><span class="p">(</span><span class="n">mnt_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_info</span><span class="p">(</span><span class="n">fsmgr_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">fstab</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此时magiskinit已经加载到内存中了，init文件也替换成原生的，按照fstab都将目录挂载好了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/init/rootdir.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">RootFSInit</span><span class="o">::</span><span class="n">patch_rootfs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Create hardlink mirror of /sbin to /root
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 创建/root目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&#34;/root&#34;</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 复制/sbin的所有属性给/root
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">clone_attr</span><span class="p">(</span><span class="s">&#34;/sbin&#34;</span><span class="p">,</span> <span class="s">&#34;/root&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建/sbin的硬链接给/root
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">link_path</span><span class="p">(</span><span class="s">&#34;/sbin&#34;</span><span class="p">,</span> <span class="s">&#34;/root&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Handle custom sepolicy rules
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 创建/dev/mnt和/dev/block目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">xmkdir</span><span class="p">(</span><span class="n">TMP_MNTDIR</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">xmkdir</span><span class="p">(</span><span class="s">&#34;/dev/block&#34;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 尝试哪个分区的块文件是可以创建的，比如userdatda、cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mount_rules_dir</span><span class="p">(</span><span class="s">&#34;/dev/block&#34;</span><span class="p">,</span> <span class="n">TMP_MNTDIR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Preserve custom rule path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">custom_rules_dir</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">string</span> <span class="n">rules_dir</span> <span class="o">=</span> <span class="s">&#34;./&#34;</span> <span class="o">+</span> <span class="n">custom_rules_dir</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">TMP_MNTDIR</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// rules_dir的路径软链到/.backup/.sepolicy.rules
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">xsymlink</span><span class="p">(</span><span class="n">rules_dir</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">TMP_RULESDIR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// patch sepolicy，会根据是否是split policy来继续make_pair的操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">patch_sepolicy</span><span class="p">(</span><span class="s">&#34;/sepolicy&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">init</span> <span class="o">=</span> <span class="n">mmap_data</span><span class="o">::</span><span class="n">rw</span><span class="p">(</span><span class="s">&#34;/init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">init</span><span class="p">.</span><span class="n">patch</span><span class="p">({</span> <span class="n">make_pair</span><span class="p">(</span><span class="n">SPLIT_PLAT_CIL</span><span class="p">,</span> <span class="s">&#34;xxx&#34;</span><span class="p">)</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Handle overlays
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ramdisk patch中已经创建了/overlay.d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/overlay.d&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Merge overlay.d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 搜索/overlay.d中的rc文件进行加入rc_list便于后续对rc的patch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">load_overlay_rc</span><span class="p">(</span><span class="s">&#34;/overlay.d&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// /overlay.d的文件、属性都移动到根目录并删除/overlay.d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">mv_path</span><span class="p">(</span><span class="s">&#34;/overlay.d&#34;</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">patch_init_rc</span><span class="p">(</span><span class="s">&#34;/init.rc&#34;</span><span class="p">,</span> <span class="s">&#34;/init.p.rc&#34;</span><span class="p">,</span> <span class="s">&#34;/sbin&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将patch后的init.rc替换原生的init.rc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rename</span><span class="p">(</span><span class="s">&#34;/init.p.rc&#34;</span><span class="p">,</span> <span class="s">&#34;/init.rc&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Dump magiskinit as magisk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// early_mount阶段把magiskinit写入内存了，这里写入/sbin/magisk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">xopen</span><span class="p">(</span><span class="s">&#34;/sbin/magisk&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这一步在rootfs挂载成rootdir之后，需要对rootdir中的文件进行patch，拆分开来看具体的动作</p>
<ul>
<li>
<p>patch sepolicy</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/init/rootdir.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">MagiskInit</span><span class="o">::</span><span class="n">patch_sepolicy</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">patch_init</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sepolicy</span> <span class="o">*</span><span class="n">sepol</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 判断是否是split policy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">SPLIT_PLAT_CIL</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;sepol: split policy</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">patch_init</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/sepolicy&#34;</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果sepolicy存在，则加载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;sepol: monolithic policy</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sepol</span> <span class="o">=</span> <span class="n">sepolicy</span><span class="o">::</span><span class="n">from_file</span><span class="p">(</span><span class="s">&#34;/sepolicy&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;sepol: no selinux</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">SELINUX_VERSION</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Mount selinuxfs to communicate with kernel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">xmount</span><span class="p">(</span><span class="s">&#34;selinuxfs&#34;</span><span class="p">,</span> <span class="n">SELINUX_MNT</span><span class="p">,</span> <span class="s">&#34;selinuxfs&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">mount_list</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">SELINUX_MNT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">patch_init</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sepol</span> <span class="o">=</span> <span class="n">sepolicy</span><span class="o">::</span><span class="n">from_split</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// magisk自身依赖的sepolicy的修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sepol</span><span class="o">-&gt;</span><span class="n">magisk_rules</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Custom rules
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 获取自定义sepolicy的规则进行patch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">custom_rules_dir</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">xopen_dir</span><span class="p">(</span><span class="n">custom_rules_dir</span><span class="p">.</span><span class="n">data</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="n">dirent</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="n">xreaddir</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">get</span><span class="p">()));)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">auto</span> <span class="n">rule</span> <span class="o">=</span> <span class="n">custom_rules_dir</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_name</span> <span class="o">+</span> <span class="s">&#34;/sepolicy.rule&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">xaccess</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Loading custom sepolicy patch: [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">rule</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sepol</span><span class="o">-&gt;</span><span class="n">load_rule_file</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Dumping sepolicy to: [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sepol</span><span class="o">-&gt;</span><span class="n">to_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">delete</span> <span class="n">sepol</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Remove OnePlus stupid debug sepolicy and use our own
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/sepolicy_debug&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">unlink</span><span class="p">(</span><span class="s">&#34;/sepolicy_debug&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">link</span><span class="p">(</span><span class="s">&#34;/sepolicy&#34;</span><span class="p">,</span> <span class="s">&#34;/sepolicy_debug&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">patch_init</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// native/jni/magiskpolicy/rules.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1">// 权限的修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">sepolicy</span><span class="o">::</span><span class="n">magisk_rules</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Temp suppress warnings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">bak</span> <span class="o">=</span> <span class="n">log_cb</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">log_cb</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">nop_log</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// This indicates API 26+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">new_rules</span> <span class="o">=</span> <span class="n">exists</span><span class="p">(</span><span class="s">&#34;untrusted_app_25&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Prevent anything to change sepolicy except ourselves
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">deny</span><span class="p">(</span><span class="n">ALL</span><span class="p">,</span> <span class="s">&#34;kernel&#34;</span><span class="p">,</span> <span class="s">&#34;security&#34;</span><span class="p">,</span> <span class="s">&#34;load_policy&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 定义type为domain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">type</span><span class="p">(</span><span class="n">SEPOL_PROC_DOMAIN</span><span class="p">,</span> <span class="s">&#34;domain&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 一系列的权限授予流程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">......</span>
</span></span><span class="line"><span class="cl">    <span class="n">permissive</span><span class="p">(</span><span class="n">SEPOL_PROC_DOMAIN</span><span class="p">);</span>  <span class="cm">/* Just in case something is missing */</span>
</span></span><span class="line"><span class="cl">    <span class="n">typeattribute</span><span class="p">(</span><span class="n">SEPOL_PROC_DOMAIN</span><span class="p">,</span> <span class="s">&#34;mlstrustedsubject&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">typeattribute</span><span class="p">(</span><span class="n">SEPOL_PROC_DOMAIN</span><span class="p">,</span> <span class="s">&#34;netdomain&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">typeattribute</span><span class="p">(</span><span class="n">SEPOL_PROC_DOMAIN</span><span class="p">,</span> <span class="s">&#34;bluetoothdomain&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">type</span><span class="p">(</span><span class="n">SEPOL_FILE_TYPE</span><span class="p">,</span> <span class="s">&#34;file_type&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">typeattribute</span><span class="p">(</span><span class="n">SEPOL_FILE_TYPE</span><span class="p">,</span> <span class="s">&#34;mlstrustedobject&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>patch sepolicy的部分总共做了三个事</p>
<ul>
<li>挂载selinuxfs，也就是/sys/fs/selinux，它来管理sepolicy</li>
<li>修改sepolicy规则，添加角色</li>
<li>添加自定义修改，这里的自定义修改是对应的module中对于sepolicy的修改</li>
</ul>
</li>
<li>
<p>patch init.rc
在patch init.rc之前会对overlays进行处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/init/rootdir.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">load_overlay_rc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">overlay</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">open_dir</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">dfd</span> <span class="o">=</span> <span class="n">dirfd</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Do not allow overwrite init.rc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 删除overlay.d目录下的init.rc，这样做是为了防止在切换overlay.d到根目录的时候覆盖原生init.rc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">unlinkat</span><span class="p">(</span><span class="n">dfd</span><span class="p">,</span> <span class="s">&#34;init.rc&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 搜索/overlay.d中的rc文件进行加入rc_list便于后续对rc的patch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">dirent</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="n">xreaddir</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">get</span><span class="p">()));)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">str_ends</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&#34;.rc&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Found rc script [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">xopenat</span><span class="p">(</span><span class="n">dfd</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">rc_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">fd_full_read</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">close</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 删除overlay.d下的其他rc文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">unlinkat</span><span class="p">(</span><span class="n">dfd</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// native/jni/init/rootdir.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">patch_init_rc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tmp_dir</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">xfopen</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s">&#34;we&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 读取init.rc文件的内容并处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">file_readline</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">string_view</span> <span class="n">line</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Do not start vaultkeeper
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// vaultkeeper是一个开源的密码管理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">str_contains</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&#34;start vaultkeeper&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Remove vaultkeeper</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Do not run flash_recovery
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 无法通过三方工具刷写recovery分区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">str_starts</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&#34;service flash_recovery&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Remove flash_recovery</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">fprintf</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">&#34;service flash_recovery /system/bin/xxxxx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 其他的都先写入/init.p.rc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Else just write the line
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">fprintf</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Inject custom rc scripts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">script</span> <span class="p">:</span> <span class="n">rc_list</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Replace template arguments of rc scripts with dynamic paths
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 使用tmp_dir路径去替换rc文件中的${MAGISKTMP}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">replace_all</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="s">&#34;${MAGISKTMP}&#34;</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fprintf</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">script</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc_list</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Inject Magisk rc scripts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="n">pfd_svc</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">ls_svc</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">bc_svc</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">gen_rand_str</span><span class="p">(</span><span class="n">pfd_svc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pfd_svc</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">gen_rand_str</span><span class="p">(</span><span class="n">ls_svc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ls_svc</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">gen_rand_str</span><span class="p">(</span><span class="n">bc_svc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bc_svc</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Inject magisk services: [%s] [%s] [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pfd_svc</span><span class="p">,</span> <span class="n">ls_svc</span><span class="p">,</span> <span class="n">bc_svc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 写入自定义的magisk服务，根据native/jni/init/magiskrc.inc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">fprintf</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">MAGISK_RC</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">,</span> <span class="n">pfd_svc</span><span class="p">,</span> <span class="n">ls_svc</span><span class="p">,</span> <span class="n">bc_svc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 写入/init.p.rc结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">fclose</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">clone_attr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// native/jni/init/magiskrc.inc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">constexpr</span> <span class="kt">char</span> <span class="n">MAGISK_RC</span><span class="p">[]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">&#34;on post-fs-data</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    start logd</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    rm &#34;</span> <span class="n">UNBLOCKFILE</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    start %2$s</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    wait &#34;</span> <span class="n">UNBLOCKFILE</span> <span class="s">&#34; &#34;</span> <span class="n">str</span><span class="p">(</span><span class="n">POST_FS_DATA_WAIT_TIME</span><span class="p">)</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    rm &#34;</span> <span class="n">UNBLOCKFILE</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 全路径的话就是/sbin/magisk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="s">&#34;service %2$s %1$s/magisk --post-fs-data</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    user root</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    seclabel u:r:&#34;</span> <span class="n">SEPOL_PROC_DOMAIN</span> <span class="s">&#34;:s0</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    oneshot</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">&#34;service %3$s %1$s/magisk --service</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    class late_start</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    user root</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    seclabel u:r:&#34;</span> <span class="n">SEPOL_PROC_DOMAIN</span> <span class="s">&#34;:s0</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    oneshot</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">&#34;on property:sys.boot_completed=1</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    start %4$s</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">&#34;service %4$s %1$s/magisk --boot-complete</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    user root</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    seclabel u:r:&#34;</span> <span class="n">SEPOL_PROC_DOMAIN</span> <span class="s">&#34;:s0</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;    oneshot</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>patch init.rc的部分总共做了三个事</p>
<ul>
<li>禁用了原生init.rc中的某些服务</li>
<li>加载rc_list，也就是overlay.d下的rc文件，和sepolicy同理，对应的是module中的修改</li>
<li>在post-fs-data、service、boot-complete三个阶段启动/sbin/magisk服务，并以SEPOL_PROC_DOMAIN的SELinux context</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 执行原生的init完成其正常的工作
</span></span></span><span class="line"><span class="cl"><span class="c1">// native/jni/init/mount.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">BaseInit</span><span class="o">::</span><span class="n">exec_init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Unmount in reverse order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">p</span> <span class="p">:</span> <span class="n">reversed</span><span class="p">(</span><span class="n">mount_list</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">xumount</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">data</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Unmount [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 继续执行init，记住这里的init已经在early_mount时替换成原生的了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">execv</span><span class="p">(</span><span class="s">&#34;/init&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>到了exec_init阶段时首先会对已挂载的目录进行卸载，这么做的原因是因为在后续已经不需要再对这些目录进行修改了，避免资源的无效占用。之后就可以根据原生的init来完成后续的操作了</p>
<h6 id="222-recoveryinit" class="heading-element"><span>2.2.2 RecoveryInit</span>
  <a href="#222-recoveryinit" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RecoveryInit</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BaseInit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">RecoveryInit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[],</span> <span class="n">cmdline</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">:</span> <span class="n">BaseInit</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">start</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Ramdisk is recovery, abort</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rename</span><span class="p">(</span><span class="s">&#34;/.backup/init&#34;</span><span class="p">,</span> <span class="s">&#34;/init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rm_rf</span><span class="p">(</span><span class="s">&#34;/.backup&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">exec_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div><p>RecoveryInit目的是为了让设备正常引导其到recovery模式，所以直接将.backup中的init文件替换过来即可</p>
<h6 id="223-sarinit" class="heading-element"><span>2.2.3 SARInit</span>
  <a href="#223-sarinit" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>略</p>
<h6 id="224-firststageinitsecondstageinit" class="heading-element"><span>2.2.4 FirstStageInit/SecondStageInit</span>
  <a href="#224-firststageinitsecondstageinit" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h6><p>前文也提到过，Android10+的设备基本都是采用2SI的方式启动，这里就把两个阶段合并在一起来讲</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/***************
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2 Stage Init
</span></span></span><span class="line"><span class="cl"><span class="cm"> ***************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FirstStageInit</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BaseInit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">prepare</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">FirstStageInit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[],</span> <span class="n">cmdline</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">:</span> <span class="n">BaseInit</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">start</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">prepare</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">exec_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SecondStageInit</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SARBase</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">prepare</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">SecondStageInit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="o">:</span> <span class="n">SARBase</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">start</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">prepare</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">patch_rootdir</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">exec_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出来，两个阶段所做的事情类似，不过由于第二阶段才真正到了system目录下，所以才会执行patch_rootdir的动作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/init/twostage.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">FirstStageInit</span><span class="o">::</span><span class="n">prepare</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">force_normal_boot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Android10+走这个分支
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 创建/first_stage_ramdisk/system/bin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">xmkdirs</span><span class="p">(</span><span class="n">FSR</span> <span class="s">&#34;/system/bin&#34;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将magiskinit重命名为/first_stage_ramdisk/system/bin/init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">rename</span><span class="p">(</span><span class="s">&#34;/init&#34;</span> <span class="cm">/* magiskinit */</span><span class="p">,</span> <span class="n">FSR</span> <span class="s">&#34;/system/bin/init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// /system/bin/init软链到/first_stage_ramdisk/init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">symlink</span><span class="p">(</span><span class="s">&#34;/system/bin/init&#34;</span><span class="p">,</span> <span class="n">FSR</span> <span class="s">&#34;/init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 备份到原生init回到/init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">rename</span><span class="p">(</span><span class="s">&#34;/.backup/init&#34;</span><span class="p">,</span> <span class="s">&#34;/init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// /.backup变成/first_stage_ramdisk/.backup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">rename</span><span class="p">(</span><span class="s">&#34;/.backup&#34;</span><span class="p">,</span> <span class="n">FSR</span> <span class="s">&#34;/.backup&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// /overlay.d变成/first_stage_ramdisk/overlay.d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">rename</span><span class="p">(</span><span class="s">&#34;/overlay.d&#34;</span><span class="p">,</span> <span class="n">FSR</span> <span class="s">&#34;/overlay.d&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 切换到/first_stage_ramdisk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">chdir</span><span class="p">(</span><span class="n">FSR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">xmkdir</span><span class="p">(</span><span class="s">&#34;/system&#34;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">xmkdir</span><span class="p">(</span><span class="s">&#34;/system/bin&#34;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rename</span><span class="p">(</span><span class="s">&#34;/init&#34;</span> <span class="cm">/* magiskinit */</span> <span class="p">,</span> <span class="s">&#34;/system/bin/init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rename</span><span class="p">(</span><span class="s">&#34;/.backup/init&#34;</span><span class="p">,</span> <span class="s">&#34;/init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">fstab_file</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">fstab_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Find existing fstab file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 寻找fstab文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nl">suffix</span> <span class="p">:</span> <span class="p">{</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fstab_suffix</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hardware</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hardware_plat</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">suffix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nl">prefix</span><span class="p">:</span> <span class="p">{</span> <span class="s">&#34;odm/etc/fstab&#34;</span><span class="p">,</span> <span class="s">&#34;vendor/etc/fstab&#34;</span><span class="p">,</span> <span class="s">&#34;fstab&#34;</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 拼接路径，比如红米note11，它的路径就是vendor/etc/fstab.mt6768
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">sprintf</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">,</span> <span class="s">&#34;%s.%s&#34;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">fstab_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Found fstab file: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">fstab_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">exit_loop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">exit_loop</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Try to load dt fstab
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">vector</span><span class="o">&lt;</span><span class="n">fstab_entry</span><span class="o">&gt;</span> <span class="n">fstab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 和RootFSInit阶段类似，当fstab目录存在时直接在该目录下收集挂载信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">read_dt_fstab</span><span class="p">(</span><span class="n">fstab</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fstab</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Dump dt fstab to fstab file in rootfs and force init to use it instead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// All dt fstab entries should be first_stage_mount
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">entry</span> <span class="p">:</span> <span class="n">fstab</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">str_contains</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">fsmgr_flags</span><span class="p">,</span> <span class="s">&#34;first_stage_mount&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">.</span><span class="n">fsmgr_flags</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                    <span class="n">entry</span><span class="p">.</span><span class="n">fsmgr_flags</span> <span class="o">+=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">entry</span><span class="p">.</span><span class="n">fsmgr_flags</span> <span class="o">+=</span> <span class="s">&#34;first_stage_mount&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">fstab_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fstab_suffix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="nl">fstab_suffix</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hardware</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="nl">hardware</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hardware_plat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="nl">hardware_plat</span> <span class="p">:</span> <span class="k">nullptr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">suffix</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;Cannot determine fstab suffix!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">sprintf</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">,</span> <span class="s">&#34;fstab.%s&#34;</span><span class="p">,</span> <span class="n">suffix</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Patch init to force IsDtFstabCompatible() return false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">init</span> <span class="o">=</span> <span class="n">mmap_data</span><span class="o">::</span><span class="n">rw</span><span class="p">(</span><span class="s">&#34;/init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">init</span><span class="p">.</span><span class="n">patch</span><span class="p">({</span> <span class="n">make_pair</span><span class="p">(</span><span class="s">&#34;android,fstab&#34;</span><span class="p">,</span> <span class="s">&#34;xxx&#34;</span><span class="p">)</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Parse and load the fstab file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Andorid10+会走这个分支
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">file_readline</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">string_view</span> <span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span> <span class="o">||</span> <span class="n">l</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">l</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">dev0</span><span class="p">,</span> <span class="n">dev1</span><span class="p">,</span> <span class="n">mnt_point0</span><span class="p">,</span> <span class="n">mnt_point1</span><span class="p">,</span> <span class="n">type0</span><span class="p">,</span> <span class="n">type1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">mnt_flags0</span><span class="p">,</span> <span class="n">mnt_flags1</span><span class="p">,</span> <span class="n">fsmgr_flags0</span><span class="p">,</span> <span class="n">fsmgr_flags1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">sscanf</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&#34;%n%*s%n %n%*s%n %n%*s%n %n%*s%n %n%*s%n&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="o">&amp;</span><span class="n">dev0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mnt_point0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mnt_point1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="o">&amp;</span><span class="n">mnt_flags0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mnt_flags1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsmgr_flags0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsmgr_flags1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">fstab_entry</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">set_info</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">set_info</span><span class="p">(</span><span class="n">mnt_point</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">set_info</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">set_info</span><span class="p">(</span><span class="n">mnt_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">set_info</span><span class="p">(</span><span class="n">fsmgr_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">fstab</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Write fstab file: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">fstab_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">xopen_file</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">,</span> <span class="s">&#34;we&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">entry</span> <span class="p">:</span> <span class="n">fstab</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Redirect system mnt_point so init won&#39;t switch root in first stage init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">mnt_point</span> <span class="o">==</span> <span class="s">&#34;/system&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">entry</span><span class="p">.</span><span class="n">mnt_point</span> <span class="o">=</span> <span class="s">&#34;/system_root&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Force remove AVB for 2SI since it may bootloop some devices
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">auto</span> <span class="n">len</span> <span class="o">=</span> <span class="n">patch_verity</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">fsmgr_flags</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">entry</span><span class="p">.</span><span class="n">fsmgr_flags</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">entry</span><span class="p">.</span><span class="n">fsmgr_flags</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">entry</span><span class="p">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">chmod</span><span class="p">(</span><span class="n">fstab_file</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">chdir</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>而exec_init都和RootFSInit方式类似，执行原生的init，下面看看第二阶段的prepare</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/init/mount.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">SecondStageInit</span><span class="o">::</span><span class="n">prepare</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">backup_files</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 卸载/init和/proc/self/exe
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">umount2</span><span class="p">(</span><span class="s">&#34;/init&#34;</span><span class="p">,</span> <span class="n">MNT_DETACH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">umount2</span><span class="p">(</span><span class="s">&#34;/proc/self/exe&#34;</span><span class="p">,</span> <span class="n">MNT_DETACH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/system_root&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">switch_root</span><span class="p">(</span><span class="s">&#34;/system_root&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">SARBase</span><span class="o">::</span><span class="n">backup_files</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果/overlay.d存在的话，加载到overlays当中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// /overlay.d必然存在，在patch ramdisk时已经添加
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/overlay.d&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">backup_folder</span><span class="p">(</span><span class="s">&#34;/overlay.d&#34;</span><span class="p">,</span> <span class="n">overlays</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">self</span> <span class="o">=</span> <span class="n">mmap_data</span><span class="o">::</span><span class="n">ro</span><span class="p">(</span><span class="s">&#34;/proc/self/exe&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// /.backup/.magisk同理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/.backup/.magisk&#34;</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">mmap_data</span><span class="o">::</span><span class="n">ro</span><span class="p">(</span><span class="s">&#34;/.backup/.magisk&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">switch_root</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Switch root to %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">root</span> <span class="o">=</span> <span class="n">xopen</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">mounts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 读取/proc/mounts的信息进行分区挂载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">parse_mnt</span><span class="p">(</span><span class="s">&#34;/proc/mounts&#34;</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">mntent</span> <span class="o">*</span><span class="n">me</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Skip root and self
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">mnt_dir</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span><span class="n">sv</span> <span class="o">||</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">mnt_dir</span> <span class="o">==</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Do not include subtrees
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">m</span> <span class="p">:</span> <span class="n">mounts</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">mnt_dir</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">m</span><span class="p">.</span><span class="n">length</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">mnt_dir</span><span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">length</span><span class="p">()]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">mounts</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">mnt_dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">dir</span> <span class="p">:</span> <span class="n">mounts</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">new_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">dir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mkdir</span><span class="p">(</span><span class="n">new_path</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">xmount</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">new_path</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">MS_MOVE</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 把/system_root挂载为根目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">xmount</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">MS_MOVE</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">chroot</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Cleaning rootfs</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">frm_rf</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第一阶段完成了system的挂载，第二阶段的prepare完成了根目录的切换，patch_rootdir可以划分为几个部分</p>
<ul>
<li>setup tmp
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// native/jni/init/rootdir.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1">// android11+移除了/sbin，因此magisk选择/dev随机目录作为存放二进制文件的目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/sbin&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="s">&#34;/sbin&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sepol</span> <span class="o">=</span> <span class="s">&#34;/sbin/.se&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">gen_rand_str</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="s">&#34;/dev/&#34;</span><span class="n">s</span> <span class="o">+</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">xmkdir</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sepol</span> <span class="o">=</span> <span class="s">&#34;/dev/.se&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// native/jni/init/mount.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Setup Magisk tmp at %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 将/devxxx挂载成tmpfs格式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">xmount</span><span class="p">(</span><span class="s">&#34;tmpfs&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s">&#34;tmpfs&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;mode=755&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 创建.magisk、.magisk/mirror等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">xmkdir</span><span class="p">(</span><span class="n">INTLROOT</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">xmkdir</span><span class="p">(</span><span class="n">MIRRDIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">xmkdir</span><span class="p">(</span><span class="n">BLOCKDIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 将./backup/.magisk写入/config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">xopen</span><span class="p">(</span><span class="n">INTLROOT</span> <span class="s">&#34;/config&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">xwrite</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 内存中的内容写入magiskinit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">fd</span> <span class="o">=</span> <span class="n">xopen</span><span class="p">(</span><span class="s">&#34;magiskinit&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">xwrite</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// The magisk binary will be handled later
</span></span></span><span class="line"><span class="cl"><span class="c1">// 做一些软链
</span></span></span><span class="line"><span class="cl"><span class="c1">// Create applet symlinks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">applet_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">xsymlink</span><span class="p">(</span><span class="s">&#34;./magisk&#34;</span><span class="p">,</span> <span class="n">applet_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="n">xsymlink</span><span class="p">(</span><span class="s">&#34;./magiskinit&#34;</span><span class="p">,</span> <span class="s">&#34;magiskpolicy&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">xsymlink</span><span class="p">(</span><span class="s">&#34;./magiskinit&#34;</span><span class="p">,</span> <span class="s">&#34;supolicy&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">chdir</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>system_root mount
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// Mount system_root mirror
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ROOTMIR</span> <span class="o">=</span> <span class="o">/</span><span class="n">devxxx</span><span class="o">/</span><span class="p">.</span><span class="n">magisk</span><span class="o">/</span><span class="n">mirror</span><span class="o">/</span><span class="n">system_root</span>
</span></span><span class="line"><span class="cl"><span class="n">xmkdir</span><span class="p">(</span><span class="n">ROOTMIR</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 通过bind mount的方法挂载到根目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">xmount</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="n">ROOTMIR</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">MS_BIND</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">mount_list</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">tmp_dir</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="n">ROOTMIR</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>patch init
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// Patch init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">patch_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">xopen</span><span class="p">(</span><span class="s">&#34;/init&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">init</span> <span class="o">=</span> <span class="n">mmap_data</span><span class="o">::</span><span class="n">ro</span><span class="p">(</span><span class="s">&#34;/init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">patch_count</span> <span class="o">=</span> <span class="n">init</span><span class="p">.</span><span class="n">patch</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 禁止加载split policy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">make_pair</span><span class="p">(</span><span class="n">SPLIT_PLAT_CIL</span><span class="p">,</span> <span class="s">&#34;xxx&#34;</span><span class="p">),</span> <span class="cm">/* Force loading monolithic sepolicy */</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将/sepolicy替换成/dev/.se
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">make_pair</span><span class="p">(</span><span class="n">MONOPOLICY</span><span class="p">,</span> <span class="n">sepol</span><span class="p">)</span>      <span class="cm">/* Redirect /sepolicy to custom path */</span>
</span></span><span class="line"><span class="cl">     <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ROOTOVL = /devxxx/.magisk/rootdir
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">xmkdir</span><span class="p">(</span><span class="n">ROOTOVL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">xopen</span><span class="p">(</span><span class="n">ROOTOVL</span> <span class="s">&#34;/init&#34;</span><span class="p">,</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将修改后的init替换原生init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">xwrite</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">init</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">init</span><span class="p">.</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fclone_attr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">close</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">close</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">patch_count</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当patch_count不为2时，也就说明修改并没有生效，因此还需要将libselinux.so中的/sepolicy路径修改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// init is dynamically linked, need to patch libselinux
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="s">&#34;/system/lib64/libselinux.so&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="s">&#34;/system/lib/libselinux.so&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">ovl</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">sprintf</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="n">ROOTOVL</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">lib</span> <span class="o">=</span> <span class="n">mmap_data</span><span class="o">::</span><span class="n">ro</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">lib</span><span class="p">.</span><span class="n">patch</span><span class="p">({</span><span class="n">make_pair</span><span class="p">(</span><span class="n">MONOPOLICY</span><span class="p">,</span> <span class="n">sepol</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl">        <span class="n">xmkdirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">ovl</span><span class="p">),</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">xopen</span><span class="p">(</span><span class="n">ovl</span><span class="p">,</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">xwrite</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">lib</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">lib</span><span class="p">.</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">close</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">clone_attr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ovl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// sepolicy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">patch_sepolicy</span><span class="p">(</span><span class="n">sepol</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>restore backup
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">sockaddr_un</span> <span class="n">sun</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="n">xsocket</span><span class="p">(</span><span class="n">AF_LOCAL</span><span class="p">,</span> <span class="n">SOCK_STREAM</span> <span class="o">|</span> <span class="n">SOCK_CLOEXEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">sun</span><span class="p">,</span> <span class="n">setup_sockaddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sun</span><span class="p">,</span> <span class="n">INIT_SOCKET</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;ACK init daemon to write backup files</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Let daemon know where tmp_dir is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">write_string</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Wait for daemon to finish restoring files
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">read_int</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Restore backup files locally</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">restore_folder</span><span class="p">(</span><span class="n">ROOTOVL</span><span class="p">,</span> <span class="n">overlays</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">overlays</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>patch init.rc
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// Patch init.rc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/init.rc&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">patch_init_rc</span><span class="p">(</span><span class="s">&#34;/init.rc&#34;</span><span class="p">,</span> <span class="n">ROOTOVL</span> <span class="s">&#34;/init.rc&#34;</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Android 11&#39;s new init.rc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">xmkdirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">ROOTOVL</span> <span class="n">NEW_INITRC</span><span class="p">),</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">patch_init_rc</span><span class="p">(</span><span class="n">NEW_INITRC</span><span class="p">,</span> <span class="n">ROOTOVL</span> <span class="n">NEW_INITRC</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>extract magisk
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">magisk</span> <span class="o">=</span> <span class="n">mmap_data</span><span class="o">::</span><span class="n">ro</span><span class="p">(</span><span class="s">&#34;magisk32.xz&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">unlink</span><span class="p">(</span><span class="s">&#34;magisk32.xz&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">xopen</span><span class="p">(</span><span class="s">&#34;magisk32&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">unxz</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">magisk</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">magisk</span><span class="p">.</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">patch_socket_name</span><span class="p">(</span><span class="s">&#34;magisk32&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;magisk64.xz&#34;</span><span class="p">,</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">magisk</span> <span class="o">=</span> <span class="n">mmap_data</span><span class="o">::</span><span class="n">ro</span><span class="p">(</span><span class="s">&#34;magisk64.xz&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">unlink</span><span class="p">(</span><span class="s">&#34;magisk64.xz&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fd</span> <span class="o">=</span> <span class="n">xopen</span><span class="p">(</span><span class="s">&#34;magisk64&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">unxz</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">magisk</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">magisk</span><span class="p">.</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">patch_socket_name</span><span class="p">(</span><span class="s">&#34;magisk64&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">xsymlink</span><span class="p">(</span><span class="s">&#34;./magisk64&#34;</span><span class="p">,</span> <span class="s">&#34;magisk&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">xsymlink</span><span class="p">(</span><span class="s">&#34;./magisk32&#34;</span><span class="p">,</span> <span class="s">&#34;magisk&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>mount rootdir
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">ROOTOVL</span> <span class="o">=</span> <span class="o">/</span><span class="n">devxxx</span><span class="o">/</span><span class="p">.</span><span class="n">magisk</span><span class="o">/</span><span class="n">rootdir</span>
</span></span><span class="line"><span class="cl"><span class="n">magic_mount</span><span class="p">(</span><span class="n">ROOTOVL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">magic_mount</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">sdir</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">ddir</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">xopen_dir</span><span class="p">(</span><span class="n">sdir</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 利用bind mount机制将修改同步到根目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">dirent</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="n">xreaddir</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">get</span><span class="p">()));)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">string</span> <span class="n">src</span> <span class="o">=</span> <span class="n">sdir</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">string</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">ddir</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">dest</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_type</span> <span class="o">==</span> <span class="n">DT_DIR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Recursive
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">magic_mount</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;Mount [%s] -&gt; [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">dest</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">xmount</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">dest</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">MS_BIND</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">magic_mount_list</span> <span class="o">+=</span> <span class="n">dest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">magic_mount_list</span> <span class="o">+=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>到这里就完成了patch rootdir的部分，最后一步也是RootFSInit一样，交由原生init接管</p>
<p>像上面分析到的RootFSInit方式和2SI方式本质上并没有太大区别，唯一的差异点就在于受制于系统启动方式改变而做的妥协，像RootFSInit方式的时候，magiskinit执行时面对的环境是根目录可写挂载的，因此RootFSInit方式可以无限制的针对rootdir进行修改，但是对于2SI方式来说，在二阶段prepare节点时完成根目录切换，而这个时候magiskinit所处的环境是根目录只读挂载，无法直接操作，因此借助于bind mount这种机制，将/devxxx/.magisk/rootdir挂载到根目录上，在原有路径下修改完成后再调用bind mount同步回根目录上，这样本质上并没有修改只读的根目录</p>
<p>到目前为止，基本上可以了解Magisk对boot.img以及booting process所做的事情，这是Magisk实现Root的保障。当然，其中还有些点会比较让人疑惑（特别是init启动这个不分），需要再结合init的源码来巩固</p>
<h3 id="五参考" class="heading-element"><span>五、参考</span>
  <a href="#%e4%ba%94%e5%8f%82%e8%80%83" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>感谢这些文章带来的启发</p>
<ol>
<li><a href="https://android.stackexchange.com/questions/213167/how-does-magisk-work"target="_blank" rel="external nofollow noopener noreferrer">https://android.stackexchange.com/questions/213167/how-does-magisk-work</a></li>
<li><a href="https://bbs.kanxue.com/thread-275939.htm#msg_header_h2_3"target="_blank" rel="external nofollow noopener noreferrer">https://bbs.kanxue.com/thread-275939.htm#msg_header_h2_3</a></li>
</ol>
</div><hr class="awesome-hr" />
    <h2 id="see-also">相关内容</h2>
    <ul><li>
          <a href="/posts/%E4%BB%8Efips-197%E4%B8%AD%E7%90%86%E8%A7%A3aes%E7%AE%97%E6%B3%95/" title="从FIPS 197中理解AES算法">从FIPS 197中理解AES算法</a></li><li>
          <a href="/posts/%E4%BB%8Efips-46-3%E4%B8%AD%E7%90%86%E8%A7%A3des%E7%AE%97%E6%B3%95/" title="从FIPS 46-3中理解DES算法">从FIPS 46-3中理解DES算法</a></li><li>
          <a href="/posts/%E4%BB%8Erfc1321%E4%B8%AD%E7%90%86%E8%A7%A3md5%E7%AE%97%E6%B3%95/" title="从RFC1321中理解MD5算法">从RFC1321中理解MD5算法</a></li><li>
          <a href="/posts/%E4%BB%8Erfc2040%E4%B8%AD%E7%90%86%E8%A7%A3rc5%E7%AE%97%E6%B3%95/" title="从RFC2040中理解RC5算法">从RFC2040中理解RC5算法</a></li><li>
          <a href="/posts/%E4%BB%8Erfc3174%E4%B8%AD%E7%90%86%E8%A7%A3sha1%E7%AE%97%E6%B3%95/" title="从RFC3174中理解SHA1算法">从RFC3174中理解SHA1算法</a></li></ul><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-06-09 22:36:47">更新于 2023-06-09&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/posts/%E9%87%8D%E8%AF%BBmagisk%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 X" data-sharer="twitter" data-url="http://localhost:1313/posts/%E9%87%8D%E8%AF%BBmagisk%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/" data-title="重读Magisk内部实现细节" data-hashtags="源码分析"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/%E9%87%8D%E8%AF%BBmagisk%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/" data-hashtag="源码分析"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/%E9%87%8D%E8%AF%BBmagisk%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82/" data-title="重读Magisk内部实现细节"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-tag" title="标签 - 源码分析">源码分析</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/%E9%87%8D%E8%AF%BBmagisk%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%822/" class="post-nav-item" rel="prev" title="重读Magisk内部实现细节2"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>重读Magisk内部实现细节2</a><a href="/posts/feistel%E5%AF%86%E7%A0%81%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/" class="post-nav-item" rel="next" title="Feistel密码结构学习">Feistel密码结构学习<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.144.2"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.16"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/">tcc0lin</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中……'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i><span class="run-times ms-1">网站运行中……</span></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><a href="https://github.com/tcc0lin" title="View source on GitHub"target="_blank" rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;width: calc(100% - var(--progress));"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/instant-page/instantpage.min.js" async defer type="module"></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/search.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":30,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"siteTime":"2021-12-18T16:15:22+08:00","typeit":{"cursorChar":"|","cursorSpeed":1000,"duration":-1,"loop":false,"speed":100},"version":"v0.3.16"};console.log('Page config:', window.config);</script><script src="/js/theme.min.js" defer></script></body>
</html>
